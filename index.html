<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunburst Editor Pro v2.31</title>
    <style>
        :root {
            --primary: #007bff;
            --primary-hover: #0056b3;
            --bg: #f4f6f8;
            --border: #e0e0e0;
            --header-bg: #f1f3f4;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: #333;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 620px;
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 12px rgba(0,0,0,0.05);
            z-index: 10;
        }

        /* --- TABS --- */
        .tabs { display: flex; background: #fff; border-bottom: 1px solid var(--border); padding: 0 10px; }
        .tab-btn {
            flex: 1; padding: 15px 0; border: none; background: transparent; cursor: pointer;
            font-weight: 600; color: #5f6368; border-bottom: 3px solid transparent; font-size: 13px; transition: color 0.2s;
        }
        .tab-btn:hover { color: var(--primary); background: #f8f9fa; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { display: none; flex-direction: column; flex-grow: 1; overflow-y: auto; position: relative; }
        .tab-content.active { display: flex; }

        /* --- GRID --- */
        #tab-grid { padding: 0; }
        .grid-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 85px 50px 30px;
            background: var(--header-bg); border-bottom: 1px solid #ccc;
            font-size: 10px; font-weight: 700; color: #5f6368; text-transform: uppercase;
            position: sticky; top: 0; z-index: 5;
        }
        .grid-header span { padding: 10px 4px; border-right: 1px solid #e0e0e0; text-align: center; }

        .data-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 85px 50px 30px;
            border-bottom: 1px solid var(--border);
        }
        .data-row:nth-child(even) { background-color: #fafafa; }
        .data-row input[type="text"].lvl-input {
            width: 100%; border: none; background: transparent; padding: 8px 4px;
            font-size: 12px; outline: none; border-right: 1px solid var(--border); box-sizing: border-box;
        }
        .data-row input:focus { background: #fff; box-shadow: inset 0 0 0 2px var(--primary); z-index: 2; }
        .data-row input.val-input { width: 100%; border: none; background: transparent; padding: 8px 4px; text-align: right; font-family: 'Consolas', monospace; color: var(--primary); font-weight: 600; font-size: 12px; border-right: 1px solid var(--border); outline: none; }

        .color-wrapper { display: flex; align-items: center; border-right: 1px solid var(--border); background: #fff; padding: 2px; }
        input[type="color"] { border: none; width: 24px; height: 24px; cursor: pointer; background: none; padding: 0; margin-right: 4px; }
        input.hex-input { width: 100%; border: none; font-family: 'Consolas', monospace; font-size: 11px; color: #444; text-transform: uppercase; outline: none; background: transparent; }

        .del-cell { display: flex; align-items: center; justify-content: center; cursor: pointer; color: #ccc; font-size: 16px; }
        .del-cell:hover { color: #dc3545; background: #fff0f0; }
        .add-row-container { padding: 10px; background: white; border-top: 1px solid var(--border); }
        .btn-add {
            background: white; color: var(--primary); border: 1px dashed var(--primary);
            padding: 8px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 600; font-size: 13px;
        }
        .btn-add:hover { background: #f0f7ff; border-style: solid; }

        /* --- SETTINGS --- */
        #tab-settings, #tab-json { padding: 20px; }
        .setting-group { margin-bottom: 20px; }
        .setting-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #444; }
        .row-group { display: flex; gap: 10px; }
        .row-group > div { flex: 1; }
        select, input[type="text"].setting-input, input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        textarea { width: 100%; height: 100%; padding: 15px; border: 1px solid var(--border); border-radius: 6px; resize: none; background: #fafafa; font-family: monospace; box-sizing: border-box; }
        input[type=range] { width: 100%; margin: 5px 0; }
        .range-val { float: right; font-size: 11px; color: #666; font-weight: normal; }

        /* --- MAIN VIEW --- */
        #main {
            flex-grow: 1; background: var(--bg); display: flex; justify-content: center; align-items: center; position: relative;
            background-image: radial-gradient(#dee2e6 1px, transparent 1px); background-size: 20px 20px;
            padding: 20px; overflow: auto;
        }
        #chart { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #chart svg {
            max-width: 100%; max-height: 100%; width: auto; height: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; display: block;
        }
        
        text.draggable { cursor: move; }
        text.draggable:hover { font-weight: 900; }

        .tooltip {
            position: absolute; background: rgba(33, 37, 41, 0.95); color: #fff; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.15s; margin-top: -10px; transform: translate(-50%, -100%); z-index: 100;
        }

        /* --- ACTION BAR --- */
        #action-bar { padding: 15px; border-top: 1px solid var(--border); background: white; display: flex; flex-direction: column; gap: 10px; }
        .update-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .update-btn:hover { background: var(--primary-hover); }
        .download-label { font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; margin-top: 5px; }
        .download-group { display: flex; gap: 8px; }
        .dl-btn { flex: 1; padding: 8px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; color: #444; transition: 0.2s; }
        .dl-btn:hover { background: #f0f0f0; border-color: #999; }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>

<div id="sidebar">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('grid')">Input Grid</button>
        <button class="tab-btn" onclick="switchTab('json')">JSON Source</button>
        <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
    </div>

    <div id="tab-grid" class="tab-content active">
        <div class="grid-header">
            <span>Level 1</span><span>Level 2</span><span>Level 3</span><span>Level 4</span><span title="Hex Code">Color</span><span style="text-align: right;">Value</span><span></span>
        </div>
        <div id="rows-container"></div>
        <div class="add-row-container">
            <button class="btn-add" onclick="addGridRow()">+ Add New Row</button>
        </div>
    </div>

    <div id="tab-json" class="tab-content"><textarea id="jsonInput"></textarea></div>

    <div id="tab-settings" class="tab-content">
        <div class="setting-group">
            <label>Output Size (px)</label>
            <div class="row-group">
                <div><input type="number" id="chartWidth" value="1000" placeholder="Width" onchange="renderCurrent()"></div>
                <div><input type="number" id="chartHeight" value="1000" placeholder="Height" onchange="renderCurrent()"></div>
            </div>
        </div>

        <div class="setting-group">
            <label>Color Theme (Resets Custom Colors)</label>
            <select id="colorTheme" onchange="applyThemeReset()">
                <option value="ocean">Ocean</option>
                <option value="sunset" selected>Sunset</option>
                <option value="forest">Forest</option>
                <option value="corporate">Corporate</option>
                <option value="neon">Neon</option>
                <option value="berry">Berry</option>
                <option value="schemeCategory10">Standard 10</option>
            </select>
            
            <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
                <label style="font-weight:600; font-size:12px; color:#444;">Per-Ring Opacity Control</label>
                
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <div style="flex:1">
                        <label style="font-size:10px; color:#666;">Level 1 (Inner)</label>
                        <input type="range" id="opL1" min="0.1" max="1" step="0.1" value="1" oninput="renderCurrent()">
                    </div>
                    <div style="flex:1">
                        <label style="font-size:10px; color:#666;">Level 2</label>
                        <input type="range" id="opL2" min="0.1" max="1" step="0.1" value="0.9" oninput="renderCurrent()">
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <div style="flex:1">
                        <label style="font-size:10px; color:#666;">Level 3</label>
                        <input type="range" id="opL3" min="0.1" max="1" step="0.1" value="0.8" oninput="renderCurrent()">
                    </div>
                    <div style="flex:1">
                        <label style="font-size:10px; color:#666;">Level 4 (Outer)</label>
                        <input type="range" id="opL4" min="0.1" max="1" step="0.1" value="0.7" oninput="renderCurrent()">
                    </div>
                </div>
            </div>
        </div>

        <div class="setting-group">
            <label>Typography & Label Color</label>
            <div class="row-group">
                <div>
                    <label style="font-weight:normal; font-size:11px;">Font</label>
                    <select id="fontFamily" onchange="renderCurrent()">
                        <option value="sans-serif">Sans-Serif</option>
                        <option value="Arial">Arial</option>
                        <option value="'Segoe UI', sans-serif">Segoe UI</option>
                        <option value="Times">Times</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight:normal; font-size:11px;">Size <span id="val-fs">12px</span></label>
                    <input type="range" id="fontSize" min="8" max="30" value="12" oninput="document.getElementById('val-fs').innerText = this.value+'px'; renderCurrent()">
                </div>
            </div>
            
            <div style="margin-top:10px; display:flex; align-items:center; justify-content:space-between; background:#f9f9f9; padding:8px; border:1px solid #eee;">
                <label style="font-weight:normal; font-size:12px; margin:0;">Label Text Color</label>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="color" id="labelColor" value="#ffffff" oninput="renderCurrent()" style="width:30px; height:25px; border:none; padding:0; cursor:pointer;">
                </div>
            </div>

            <div class="row-group" style="margin-top:10px;">
                <div>
                    <label style="font-weight:normal; font-size:11px;">Weight</label>
                    <select id="fontWeight" onchange="renderCurrent()">
                        <option value="normal">Normal</option>
                        <option value="bold">Bold</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight:normal; font-size:11px;">Style</label>
                    <select id="fontStyle" onchange="renderCurrent()">
                        <option value="normal">Normal</option>
                        <option value="italic">Italic</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="setting-group">
            <label>Visual Style</label>
            <select id="visualStyle" onchange="renderCurrent()">
                <option value="flat" selected>Flat (Standard)</option>
                <option value="bevel">3D Bevel (Raised)</option>
                <option value="shadow">Drop Shadow</option>
                <option value="glow">Outer Glow</option>
            </select>
        </div>

        <div class="setting-group">
            <label>Labels Positioning</label>
            <select id="labelOrientation" onchange="renderCurrent()">
                <option value="auto" selected>Auto (Radial)</option>
                <option value="horizontal">Horizontal (Straight)</option>
                <option value="tangential">Tangential (Perpendicular)</option>
            </select>
            <label style="font-weight:normal; font-size:11px; margin-top:8px;">Rotation <span id="val-rot" class="range-val">0°</span></label>
            <input type="range" id="labelRotation" min="-180" max="180" value="0" oninput="updateRangeLabel('rot', this.value, '°'); renderCurrent()">
            
            <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;">
                <label style="font-weight:normal; font-size:11px;">Position Strategy</label>
                <select id="labelPosition" onchange="toggleLabelControls(); renderCurrent()">
                    <option value="inside">Inside Slices</option>
                    <option value="outside" selected>Outside (Leaves Only)</option>
                </select>
            </div>
            <div id="labelOffsetControl" style="margin-top:10px;">
                <label style="font-weight: normal; font-size: 12px;">Distance (Outside) <span id="val-dist" class="range-val">10px</span></label>
                <input type="range" id="labelDist" min="0" max="100" value="10" oninput="updateRangeLabel('dist', this.value, 'px'); renderCurrent()">
            </div>
        </div>

        <div class="setting-group">
            <label>Background</label>
            <div style="display:flex; align-items:center; gap:10px; background:#f9f9f9; padding:8px; border-radius:4px; border:1px solid #ddd;">
                <label style="font-weight:normal; font-size:12px; display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="bgTransparent" checked onchange="toggleBgColor()"> 
                    &nbsp;Transparent
                </label>
                <div style="width:1px; height:20px; background:#ccc;"></div>
                <input type="color" id="bgColor" value="#ffffff" disabled oninput="renderCurrent()" style="width:40px; height:25px; padding:0; border:none; cursor:pointer;">
            </div>
        </div>

        <div class="setting-group">
            <label>Spacing</label>
            <label style="font-weight: normal; font-size: 12px;">Chart Margin <span id="val-pad" class="range-val">50px</span></label>
            <input type="range" id="chartPadding" min="0" max="300" value="50" oninput="updateRangeLabel('pad', this.value, 'px'); renderCurrent()">
            <label style="font-weight: normal; font-size: 12px; margin-top:5px;">Slice Gap <span id="val-gap" class="range-val">2px</span></label>
            <input type="range" id="sliceGap" min="0" max="20" value="2" oninput="updateRangeLabel('gap', this.value, 'px'); renderCurrent()">
            <label style="font-weight: normal; font-size: 12px; margin-top:5px;">Ring Padding <span id="val-ring" class="range-val">2px</span></label>
            <input type="range" id="ringGap" min="0" max="20" value="2" oninput="updateRangeLabel('ring', this.value, 'px'); renderCurrent()">
        </div>

        <div class="setting-group">
            <label>Chart Title</label>
            <input type="text" class="setting-input" id="chartTitle" placeholder="My Sunburst Chart" oninput="renderCurrent()">
        </div>

        <div class="setting-group">
            <label>Label Content</label>
            <select id="labelContent" onchange="renderCurrent()">
                <option value="name">Name Only</option>
                <option value="value">Value Only</option>
                <option value="percent" selected>Percentage Only</option>
                <option value="name_percent">Name + Percentage</option>
                <option value="name_value">Name + Value</option>
                <option value="all">All</option>
            </select>
        </div>

        <div class="setting-group">
            <label>Label Visibility</label>
            <select id="showLabels" onchange="renderCurrent()">
                <option value="auto">Auto (Hide small)</option>
                <option value="all">Always Show All</option>
                <option value="none">Hide All</option>
            </select>
        </div>

        <div class="setting-group">
            <label>Center Content</label>
            <select id="centerContent" onchange="renderCurrent()">
                <option value="total" selected>Total Value</option>
                <option value="name">Root Name</option>
                <option value="both">Name + Total</option>
                <option value="none">Empty Hole</option>
            </select>
        </div>
    </div>

    <div id="action-bar">
        <button class="update-btn" onclick="syncAndRender()">Update Chart Preview</button>
        <div class="download-label">Export Options</div>
        <div class="download-group">
            <button class="dl-btn" onclick="downloadImage('svg')">SVG</button>
            <button class="dl-btn" onclick="downloadImage('png')">PNG</button>
            <button class="dl-btn" onclick="downloadImage('jpeg')">JPEG</button>
        </div>
    </div>
</div>

<div id="main">
    <div id="chart"></div>
    <div id="tooltip" class="tooltip"></div>
</div>

<script>
    let activeTab = 'grid';
    let gridData = [
        { l1: "Marketing", l2: "Social", l3: "FB", l4: "", color: "#29aef6", val: 500 },
        { l1: "Marketing", l2: "Social", l3: "IG", l4: "", color: "#29aef6", val: 300 },
        { l1: "Sales", l2: "Direct", l3: "", l4: "", color: "#ff9800", val: 400 },
        { l1: "Sales", l2: "Channel", l3: "", l4: "", color: "#ff9800", val: 200 }
    ];

    const THEMES = {
        ocean: ["#0077b6", "#0096c7", "#48cae4", "#90e0ef", "#023e8a", "#00b4d8"],
        sunset: ["#ff595e", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93", "#ff924c"],
        forest: ["#2d6a4f", "#40916c", "#52b788", "#74c69d", "#b7e4c7", "#1b4332"],
        corporate: ["#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51", "#2b2d42"],
        neon: ["#f72585", "#7209b7", "#3a0ca3", "#4361ee", "#4cc9f0", "#b5179e"],
        berry: ["#5e548e", "#9f86c0", "#be95c4", "#e0b1cb", "#231942", "#7209b7"]
    };

    function init() { toggleLabelControls(); renderGridRows(); syncGridToJson(); }

    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="switchTab('${t}')"]`).classList.add('active');
        document.getElementById(`tab-${t}`).classList.add('active');
        if (activeTab === 'grid' && t === 'json') syncGridToJson();
        activeTab = t;
    }

    function updateRangeLabel(id, val, suffix) { document.getElementById(`val-${id}`).innerText = val + suffix; }
    
    function toggleLabelControls() {
        const pos = document.getElementById('labelPosition').value;
        const ctrl = document.getElementById('labelOffsetControl');
        ctrl.style.display = (pos === 'outside') ? 'block' : 'none';
    }
    
    function toggleBgColor() {
        document.getElementById('bgColor').disabled = document.getElementById('bgTransparent').checked;
        renderCurrent();
    }

    function applyThemeReset() {
        gridData.forEach(row => { row.color = "#000000"; });
        const wrappers = document.querySelectorAll('.color-wrapper');
        wrappers.forEach(w => {
            w.querySelector('input[type="color"]').value = "#000000";
            w.querySelector('.hex-input').value = "#000000";
        });
        syncAndRender();
    }

    function renderGridRows() {
        const c = document.getElementById('rows-container'); c.innerHTML = '';
        gridData.forEach((r, i) => {
            const d = document.createElement('div'); d.className = 'data-row';
            const col = r.color || "#000000"; 
            d.innerHTML = `
                <input type="text" class="lvl-input" value="${r.l1}" onchange="updateGridData(${i}, 'l1', this.value)">
                <input type="text" class="lvl-input" value="${r.l2}" onchange="updateGridData(${i}, 'l2', this.value)">
                <input type="text" class="lvl-input" value="${r.l3}" onchange="updateGridData(${i}, 'l3', this.value)">
                <input type="text" class="lvl-input" value="${r.l4}" onchange="updateGridData(${i}, 'l4', this.value)">
                <div class="color-wrapper">
                    <input type="color" value="${col}" oninput="handleColorChange(${i}, this.value, 'picker')">
                    <input type="text" class="hex-input" value="${col}" oninput="handleColorChange(${i}, this.value, 'text')">
                </div>
                <input type="number" class="val-input" value="${r.val}" onchange="updateGridData(${i}, 'val', this.value)">
                <div class="del-cell" onclick="removeGridRow(${i})">×</div>`;
            c.appendChild(d);
        });
    }
    
    function addGridRow() { 
        const prev = gridData.length ? gridData[gridData.length-1] : null;
        const l1 = prev ? prev.l1 : "";
        const col = prev ? prev.color : "#000000";
        gridData.push({l1: l1, l2:"", l3:"", l4:"", color: col, val:0}); 
        renderGridRows(); 
    }
    function removeGridRow(i) { gridData.splice(i, 1); renderGridRows(); }
    function updateGridData(i, k, v) { gridData[i][k] = v; }

    function handleColorChange(idx, val, source) {
        if (source === 'text' && !/^#[0-9A-F]{6}$/i.test(val)) return;
        updateGridData(idx, 'color', val);
        const row = document.getElementById('rows-container').children[idx];
        if(source === 'picker') row.querySelector('.hex-input').value = val;
        if(source === 'text') row.querySelector('input[type="color"]').value = val;
        const currentL1 = gridData[idx].l1;
        if (currentL1) {
            gridData.forEach((r, i) => {
                if (r.l1 === currentL1) {
                    r.color = val;
                    const rNode = document.getElementById('rows-container').children[i];
                    if (rNode) {
                        rNode.querySelector('input[type="color"]').value = val;
                        rNode.querySelector('.hex-input').value = val;
                    }
                }
            });
        }
        syncAndRender();
    }

    function syncGridToJson() {
        const rootName = gridData[0]?.l1 || "Root";
        const root = { name: rootName, children: [] };
        gridData.forEach(r => {
            if(!r.l1) return;
            let l1 = root.children.find(c => c.name === r.l1);
            if(!l1) { l1 = { name: r.l1, children: [] }; if(r.color!=="#000000") l1.color = r.color; root.children.push(l1); }
            if(!r.l2 && !r.l3 && !r.l4) { if((+r.val||0)>0) l1.value=(l1.value||0)+(+r.val); return; }

            let l2 = l1.children.find(c => c.name === r.l2);
            if(!l2 && r.l2) { l2 = { name: r.l2, children: [] }; l1.children.push(l2); }
            if(!l2) return;
            if(!r.l3 && !r.l4) { if((+r.val||0)>0) l2.value=(l2.value||0)+(+r.val); return; }

            let l3 = l2.children.find(c => c.name === r.l3);
            if(!l3 && r.l3) { l3 = { name: r.l3, children: [] }; l2.children.push(l3); }
            if(!l3) return;
            if(!r.l4) { if((+r.val||0)>0) l3.value=(l3.value||0)+(+r.val); return; }

            let l4 = l3.children.find(c => c.name === r.l4);
            if(!l4 && r.l4) { if((+r.val||0)>0) { l4 = { name: r.l4, value: +r.val }; l3.children.push(l4); } }
        });
        document.getElementById('jsonInput').value = JSON.stringify(root, null, 2);
        renderChart(root);
    }
    
    function syncAndRender() {
        if(activeTab === 'grid') syncGridToJson();
        else try { renderChart(JSON.parse(document.getElementById('jsonInput').value)); } catch(e) { alert("Invalid JSON"); }
    }
    function renderCurrent() { syncAndRender(); }

    function renderChart(data) {
        d3.select("#chart").html("");
        
        const width = parseInt(document.getElementById('chartWidth').value) || 1000;
        const height = parseInt(document.getElementById('chartHeight').value) || 1000;
        const title = document.getElementById('chartTitle').value;
        const fontFamily = document.getElementById('fontFamily').value;
        const fontSize = document.getElementById('fontSize').value + 'px';
        const fontWeight = document.getElementById('fontWeight').value;
        const fontStyle = document.getElementById('fontStyle').value;
        const labelColor = document.getElementById('labelColor').value || "#ffffff";
        const themeVal = document.getElementById('colorTheme').value;
        const visualStyle = document.getElementById('visualStyle').value;
        
        const labelPosEl = document.getElementById('labelPosition');
        const labelPosition = labelPosEl ? labelPosEl.value : 'inside';
        const labelRotEl = document.getElementById('labelRotation');
        const rotationOffset = labelRotEl ? (parseInt(labelRotEl.value) || 0) : 0;
        const labelOrEl = document.getElementById('labelOrientation');
        const orientation = labelOrEl ? labelOrEl.value : 'auto';

        const padding = parseInt(document.getElementById('chartPadding').value) || 50;
        const sliceGap = parseFloat(document.getElementById('sliceGap').value) || 0;
        const ringGap = parseFloat(document.getElementById('ringGap').value) || 0;
        const labelDist = parseInt(document.getElementById('labelDist').value) || 10;
        const showLabels = document.getElementById('showLabels').value;
        const labelContent = document.getElementById('labelContent').value;
        const centerContent = document.getElementById('centerContent').value;
        
        const bgTrans = document.getElementById('bgTransparent').checked;
        const bgColor = document.getElementById('bgColor').value;

        // NEW: GET INDIVIDUAL OPACITY SETTINGS
        const opL1 = parseFloat(document.getElementById('opL1').value) || 1;
        const opL2 = parseFloat(document.getElementById('opL2').value) || 1;
        const opL3 = parseFloat(document.getElementById('opL3').value) || 1;
        const opL4 = parseFloat(document.getElementById('opL4').value) || 1;

        const svg = d3.select("#chart").append("svg")
            .attr("width", width).attr("height", height)
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("xmlns", "http://www.w3.org/2000/svg").style("font-family", fontFamily);
        
        if(!bgTrans) svg.style("background-color", bgColor);

        const defs = svg.append("defs");
        const shadow = defs.append("filter").attr("id", "drop-shadow").attr("height", "130%");
        shadow.append("feGaussianBlur").attr("in", "SourceAlpha").attr("stdDeviation", 3);
        shadow.append("feOffset").attr("dx", 2).attr("dy", 2).attr("result", "offsetblur");
        shadow.append("feFlood").attr("flood-color", "rgba(0,0,0,0.3)");
        shadow.append("feComposite").attr("in2", "offsetblur").attr("operator", "in");
        const merge = shadow.append("feMerge");
        merge.append("feMergeNode");
        merge.append("feMergeNode").attr("in", "SourceGraphic");

        const bevel = defs.append("filter").attr("id", "bevel-filter")
            .attr("x", "-50%").attr("y", "-50%").attr("width", "200%").attr("height", "200%");
        bevel.append("feGaussianBlur").attr("in", "SourceAlpha").attr("stdDeviation", 2).attr("result", "blur");
        bevel.append("feSpecularLighting").attr("in", "blur").attr("surfaceScale", 5)
            .attr("specularConstant", 0.5).attr("specularExponent", 10)
            .attr("result", "specOut").attr("lighting-color", "white")
            .append("fePointLight").attr("x", -5000).attr("y", -10000).attr("z", 20000);
        bevel.append("feComposite").attr("in", "specOut").attr("in2", "SourceAlpha").attr("operator", "in").attr("result", "specOut");
        bevel.append("feComposite").attr("in", "SourceGraphic").attr("in2", "specOut")
            .attr("operator", "arithmetic").attr("k1", 0).attr("k2", 1).attr("k3", 1).attr("k4", 0);

        const glow = defs.append("filter").attr("id", "glow-filter");
        glow.append("feGaussianBlur").attr("stdDeviation", "2.5").attr("result", "coloredBlur");
        const mergeGlow = glow.append("feMerge");
        mergeGlow.append("feMergeNode").attr("in", "coloredBlur");
        mergeGlow.append("feMergeNode").attr("in", "SourceGraphic");

        let filterUrl = null;
        if(visualStyle === 'shadow') filterUrl = "url(#drop-shadow)";
        if(visualStyle === 'bevel') filterUrl = "url(#bevel-filter)";
        if(visualStyle === 'glow') filterUrl = "url(#glow-filter)";

        const titleH = title ? 50 : 0;
        if(title) {
            svg.append("text")
               .attr("x", width/2).attr("y", 40)
               .attr("text-anchor", "middle")
               .style("font-size", "24px").style("font-weight", "bold").style("fill", "#333").text(title);
        }

        const g = svg.append("g").attr("transform", `translate(${width/2}, ${(height/2) + (titleH/2)})`);

        const effW = Math.max(10, width - (padding * 2));
        const effH = Math.max(10, height - titleH - (padding * 2));
        const r = Math.min(effW, effH) / 2;

        let colorScale;
        if(THEMES[themeVal]) colorScale = d3.scaleOrdinal(THEMES[themeVal]);
        else colorScale = d3.scaleOrdinal(d3[themeVal]);

        const root = d3.partition().size([2*Math.PI, r])(
            d3.hierarchy(data).sum(d=>d.value).sort((a,b)=>b.value-a.value)
        );

        const arc = d3.arc().startAngle(d=>d.x0).endAngle(d=>d.x1)
            .padAngle(sliceGap * 0.005).padRadius(r/2)
            .innerRadius(d=>d.y0).outerRadius(d => Math.max(d.y0, d.y1 - ringGap));

        g.selectAll("path").data(root.descendants().filter(d=>d.depth && d.value > 0)).join("path")
            .attr("fill", d => {
                if(d.data.color && d.data.color !== "#000000") return d.data.color;
                let anc = d.parent; while(anc) { if(anc.data.color && anc.data.color !== "#000000") return anc.data.color; anc = anc.parent; }
                let l1 = d; while(l1.depth > 1) l1 = l1.parent;
                return colorScale(l1.data.name);
            })
            // APPLY INDIVIDUAL OPACITY
            .attr("opacity", d => {
                if (d.depth === 1) return opL1;
                if (d.depth === 2) return opL2;
                if (d.depth === 3) return opL3;
                if (d.depth >= 4) return opL4;
                return 1;
            })
            .attr("d", arc)
            .style("filter", filterUrl)
            .on("mouseover", (e,d)=>{
                d3.select("#tooltip").style("opacity",1).html(`<strong>${d.data.name}</strong><br>${d.value} (${root.value>0 ? ((d.value/root.value)*100).toFixed(1) : 0}%)`)
                  .style("left", e.pageX+"px").style("top", e.pageY+"px");
            }).on("mouseout", ()=>d3.select("#tooltip").style("opacity",0));

        if(showLabels !== 'none') {
            const labels = g.append("g").attr("class", "labels-layer")
                .selectAll("text")
                .data(root.descendants().filter(d => d.depth && d.value > 0 && (showLabels==='all' || (d.y0+d.y1)/2*(d.x1-d.x0)>10)))
                .join("text")
                .attr("class", "draggable")
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .style("font-size", fontSize)
                .style("font-weight", d => (labelPosition === 'outside' && !d.children) ? "bold" : fontWeight)
                .style("font-style", fontStyle)
                .style("fill", labelColor)
                .style("text-shadow", d => (labelPosition === 'outside' && !d.children) ? "none" : "0 0 3px rgba(0,0,0,0.6)")
                .text(d => {
                    let pct = root.value>0 ? ((d.value / root.value) * 100).toFixed(1)+"%" : "0%";
                    if (labelContent === 'percent') return pct;
                    if (labelContent === 'name_percent') return `${d.data.name} (${pct})`;
                    if (labelContent === 'name_value') return `${d.data.name} (${d.value})`;
                    if (labelContent === 'all') return `${d.data.name}: ${d.value} (${pct})`;
                    if (labelContent === 'value') return d.value;
                    return d.data.name;
                });

            labels.each(function(d) {
                const angle = (d.x0 + d.x1) / 2; 
                let radius = (d.y0 + d.y1) / 2;
                if (labelPosition === 'outside' && !d.children) radius = r + labelDist;

                const cx = radius * Math.cos(angle - Math.PI/2);
                const cy = radius * Math.sin(angle - Math.PI/2);
                
                let rotate = 0;
                const degrees = (angle * 180 / Math.PI) - 90;

                if (labelPosition === 'outside' && !d.children) {
                     rotate = (angle > Math.PI) ? degrees + 180 : degrees;
                     if(orientation === 'horizontal') rotate = 0;
                } else {
                    if(orientation === 'auto') {
                        rotate = degrees;
                        if (rotate > 90) rotate += 180; 
                        if (rotate < -90) rotate += 180;
                    } else if (orientation === 'tangential') {
                        rotate = degrees + 90;
                    } else {
                        rotate = 0;
                    }
                }
                
                rotate += rotationOffset;
                d3.select(this).attr("transform", `translate(${cx},${cy}) rotate(${rotate})`);
            });

            labels.call(d3.drag()
                .on("start", function() { d3.select(this).raise(); })
                .on("drag", function(event) {
                    const t = d3.select(this).attr("transform");
                    const translate = t.match(/translate\(([^,]+),([^)]+)\)/);
                    let currX = parseFloat(translate[1]);
                    let currY = parseFloat(translate[2]);
                    currX += event.dx;
                    currY += event.dy;
                    const rotate = t.match(/rotate\([^)]+\)/) ? t.match(/rotate\([^)]+\)/)[0] : "";
                    d3.select(this).attr("transform", `translate(${currX},${currY}) ${rotate}`);
                })
            );
        }

        if(centerContent !== 'none') {
            const cg = g.append("g").attr("text-anchor","middle").style("fill","#333");
            const tot = Math.round(root.value);
            if(centerContent === 'total') cg.append("text").text(tot).attr("dy", "0.3em").style("font-size", "26px").style("font-weight", "bold");
            else if(centerContent === 'name') cg.append("text").text(root.data.name).attr("dy", "0.3em").style("font-size", "20px").style("font-weight", "bold");
            else {
                cg.append("text").text(root.data.name).attr("dy", "-0.3em").style("font-size", "14px").style("fill", "#666");
                cg.append("text").text(tot).attr("dy", "1.0em").style("font-size", "22px").style("font-weight", "bold");
            }
        }
    }

    function downloadImage(format) {
        const svgEl = document.querySelector("svg");
        let svgData = new XMLSerializer().serializeToString(svgEl);
        const w = parseInt(svgEl.getAttribute("width"));
        const h = parseInt(svgEl.getAttribute("height"));
        
        if (format === 'svg') {
            const bgTrans = document.getElementById('bgTransparent').checked;
            const bgColor = document.getElementById('bgColor').value;
            if(!bgTrans) {
                const bgRect = `<rect width="100%" height="100%" fill="${bgColor}"/>`;
                svgData = svgData.replace('>', `>${bgRect}`);
            }
            const blob = new Blob([svgData.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"')], {type: "image/svg+xml;charset=utf-8"});
            triggerDownload(URL.createObjectURL(blob), "sunburst_chart.svg");
            return;
        }
        
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        canvas.width = w; canvas.height = h;
        const svgBlob = new Blob([svgData], {type: "image/svg+xml;charset=utf-8"});
        const url = URL.createObjectURL(svgBlob);
        
        img.onload = function() {
            const bgTrans = document.getElementById('bgTransparent').checked;
            const bgColor = document.getElementById('bgColor').value;
            if (format === 'jpeg') {
                ctx.fillStyle = bgTrans ? "#ffffff" : bgColor;
                ctx.fillRect(0, 0, w, h);
            } else if (format === 'png' && !bgTrans) {
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, w, h);
            }
            ctx.drawImage(img, 0, 0, w, h);
            triggerDownload(canvas.toDataURL(`image/${format}`, 0.9), `sunburst_chart.${format}`);
            URL.revokeObjectURL(url);
        };
        img.src = url;
    }
    function triggerDownload(url, filename) {
        const link = document.createElement("a"); link.href = url; link.download = filename;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    init();
</script>
</body>
</html>
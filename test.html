<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker Pro (Mahira Sync)</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script type="module">
        // Using the specific version you provided
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        
        // Expose Firebase functions to global scope for the app logic
        window.firebaseModules = { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, getFirestore, doc, getDoc, setDoc };
        
        // Dispatch event to signal Firebase is ready to load
        window.dispatchEvent(new Event('firebase-modules-loaded'));
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* --- ðŸŽ¨ THEME CONFIGURATION --- */
            --bg-body: #0b0e14;   
            --primary: #2dd4bf;   
            --secondary: #fbbf24; 
            --text-main: #f1f5f9; 
            
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --danger: #f43f5e;
            --text-muted: #94a3b8;
            --calc-bg: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 10% 20%, var(--primary) 0%, transparent 20%), 
                radial-gradient(circle at 90% 80%, var(--secondary) 0%, transparent 20%);
            background-size: 100% 100%;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; 
        }

        select option { background-color: var(--bg-body); color: var(--text-main); padding: 10px; }

        /* --- AUTHENTICATION SCREENS CSS --- */
        #auth-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(20px);
            background: rgba(11, 14, 20, 0.8);
        }

        .auth-card {
            width: 400px; max-width: 90%;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-align: center;
            display: block; 
            animation: fadeIn 0.4s ease-out;
        }

        .auth-logo { font-size: 3rem; color: var(--primary); margin-bottom: 10px; }
        .auth-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; }
        .auth-sub { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 30px; }

        /* Google Button Style */
        .google-btn {
            width: 100%; padding: 12px; background: white;
            color: #333; border: none; border-radius: 8px;
            font-weight: 600; font-size: 1rem; cursor: pointer;
            margin-top: 10px; transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .google-btn:hover { transform: scale(1.02); background: #f1f1f1; }
        .google-btn i { color: #DB4437; font-size: 1.2rem; }

        /* --- MAIN APP WRAPPER --- */
        #app-wrapper {
            display: none; 
            width: 100%; height: 100%;
            display: flex; 
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 25px;
            z-index: 20;
            overflow-y: auto;
        }

        .app-title { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 12px; }

        /* PROFILE STYLES */
        .profile-container {
            display: flex; flex-direction: column; align-items: center;
            max-width: 600px; margin: 0 auto; width: 100%;
        }

        .profile-header-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 30px; width: 100%;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .profile-header-card::before {
            content:''; position: absolute; top:0; left:0; width:100%; height:80px;
            background: linear-gradient(to right, rgba(45, 212, 191, 0.2), rgba(251, 191, 36, 0.2));
            z-index: 0;
        }

        .profile-img-lg {
            width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--bg-body);
            z-index: 1; margin-top: 20px; object-fit: cover; background: #000;
        }
        
        .profile-name-lg { font-size: 1.5rem; font-weight: 700; margin-top: 10px; z-index: 1; }
        .profile-badge-lg { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; color: var(--primary); margin-top: 5px; z-index: 1; }
        
        .profile-stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 25px; z-index: 1;
        }
        .p-stat-box {
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px;
        }
        .p-stat-num { font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
        .p-stat-lbl { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .settings-group { width: 100%; display: flex; flex-direction: column; gap: 10px; }
        .settings-btn {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 12px; color: var(--text-main);
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: 0.2s; font-size: 0.95rem;
        }
        .settings-btn:hover { background: rgba(255,255,255,0.05); }
        .settings-btn.danger { border-color: rgba(244, 63, 94, 0.3); color: var(--danger); }
        .settings-btn.danger:hover { background: rgba(244, 63, 94, 0.1); }

        /* --- MAIN AREA --- */
        #main { 
            flex-grow: 1; position: relative; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        .report-header { 
            padding: 20px 25px; 
            display: flex; flex-direction: column; gap: 15px;
            background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(5px); border-bottom: 1px solid var(--glass-border); flex-shrink: 0; z-index: 15;
        }
        
        .header-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .report-title { font-size: 1.5rem; font-weight: 700; }
        
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .header-select { width: auto; padding: 8px 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-main); cursor: pointer; border-radius: 8px; font-size: 0.85rem; }
        
        .custom-date-row {
            display: none; width: 100%; gap: 10px; align-items: center; 
            padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.05);
            animation: slideDown 0.2s ease;
        }
        .custom-date-row.show { display: flex; }
        @keyframes slideDown { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }
        
        .date-input-group { display: flex; align-items: center; gap: 8px; flex: 1; }
        .date-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; white-space: nowrap; }
        .custom-date-input { width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-main); font-size: 0.85rem; }

        .currency-wrapper { position: relative; display: flex; align-items: center; }
        .spinner { position: absolute; right: 30px; pointer-events: none; border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid var(--primary); border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* VIEW CONTAINER */
        .view-container {
            flex-grow: 1; overflow-y: auto; 
            padding: 25px 25px 120px 25px; 
            display: none; 
        }
        .view-container.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card {
            background: var(--glass-bg); backdrop-filter: blur(10px); padding: 25px; border-radius: 16px;
            border: 1px solid var(--glass-border); display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .stat-title { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .stat-val { font-size: 2rem; font-weight: 700; margin-top: 10px; letter-spacing: -1px; }
        .stat-val.pos { color: var(--primary); }
        .stat-val.neg { color: var(--secondary); }

        .dashboard-lower { display: flex; flex-direction: column; gap: 25px; min-height: 400px; }
        
        /* EXPENSE FLOW CHART */
        .flow-container {
            background: var(--glass-bg); backdrop-filter: blur(10px); padding: 20px; border-radius: 16px;
            border: 1px solid var(--glass-border); margin-bottom: 20px; display: flex; flex-direction: column;
            position: relative; 
        }
        #chart-flow { width: 100%; height: 200px; position: relative; }
        
        .flow-tooltip {
            position: absolute; 
            background: rgba(15, 23, 42, 0.95); border: 1px solid var(--danger);
            padding: 8px 12px; border-radius: 8px; pointer-events: none; opacity: 0; 
            font-size: 12px; z-index: 1000; color: white; 
            transform: translate(-50%, -100%); 
            transition: opacity 0.1s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            margin-top: -10px;
        }

        .flow-daily-strip {
            display: flex; gap: 10px; overflow-x: auto; padding: 15px 0 5px 0;
            border-top: 1px solid rgba(255,255,255,0.05); margin-top: 10px;
        }
        .flow-daily-item {
            min-width: 70px; background: rgba(255,255,255,0.02); border-radius: 8px; padding: 8px 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid transparent; transition: all 0.2s; flex-shrink: 0;
        }
        .flow-daily-item:hover { background: rgba(255,255,255,0.05); border-color: var(--glass-border); }
        .flow-day { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }
        .flow-date { font-size: 0.85rem; font-weight: bold; margin: 2px 0; }
        .flow-amt { font-size: 0.7rem; color: var(--danger); font-family: 'Consolas', monospace; font-weight: 700; white-space: nowrap; }

        /* SPENDING BREAKDOWN */
        .top-cats-container {
            background: var(--glass-bg); backdrop-filter: blur(10px); padding: 30px; border-radius: 16px;
            border: 1px solid var(--glass-border); position: relative; display: flex; flex-direction: column;
            width: 100%; height: 550px;
        }
        .chart-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .chart-title { font-size: 1.1rem; font-weight: 600; color: var(--text-muted); margin: 0; }

        .chart-controls-right { display: flex; gap: 10px; align-items: center; }
        .chart-switch-group { display: flex; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 2px; border: 1px solid var(--glass-border); }
        .chart-switch-btn { 
            background: transparent; border: none; color: var(--text-muted); padding: 5px 12px; 
            font-size: 0.75rem; font-weight: 600; cursor: pointer; border-radius: 6px; 
        }
        .chart-switch-btn.active { background: rgba(255,255,255,0.1); color: var(--text-main); }
        
        .chart-label-select {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-muted);
            border-radius: 6px; padding: 4px 8px; font-size: 0.75rem; outline: none;
        }
        
        #chart-cats { flex-grow: 1; width: 100%; height: 100%; position: relative; }
        .chart-tooltip { position: absolute; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--primary); padding: 8px 12px; border-radius: 6px; pointer-events: none; opacity: 0; font-size: 12px; z-index: 100; color: white; transform: translate(-50%, -120%); transition: opacity 0.1s; }
        
        .slice-label { font-size: 11px; fill: var(--text-muted); font-weight: 500; pointer-events: none; }
        .slice-label-inner { font-size: 10px; fill: rgba(0,0,0,0.6); font-weight: 700; pointer-events: none; text-shadow: none; }
        .slice-line { stroke: var(--text-muted); stroke-width: 1px; fill: none; opacity: 0.3; }

        /* LISTS */
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .detail-table th { text-align: left; padding: 15px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--glass-border); }
        .detail-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.03); color: var(--text-main); font-size: 0.95rem; }
        .detail-table tr:hover { background: rgba(255,255,255,0.02); }
        .detail-icon { width: 32px; height: 32px; background: rgba(255,255,255,0.05); border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; color: var(--text-muted); font-size: 0.85rem; }
        .empty-state { text-align: center; color: var(--text-muted); padding: 50px; font-style: italic; }
        .method-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-muted); margin-left: 5px; }

        /* CATEGORIES VIEW STYLES */
        .cat-section-title { font-size: 0.85rem; font-weight: 700; color: var(--primary); margin: 25px 0 15px 0; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .cat-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s; }
        .cat-list-item:hover { background: rgba(255,255,255,0.02); }
        .cat-left { display: flex; align-items: center; gap: 15px; }
        .cat-icon-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .cat-name { font-weight: 500; font-size: 1rem; color: var(--text-main); }
        .cat-right { text-align: right; }
        .cat-amount { font-weight: 700; font-family: 'Consolas', monospace; font-size: 1rem; }
        .cat-count { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 25px;
            display: flex; padding: 5px 10px; gap: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 100;
            align-items: center; width: auto; max-width: 95%; overflow-x: auto;
        }
        .nav-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 10px 12px; border-radius: 15px; cursor: pointer;
            font-size: 0.7rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s;
            min-width: 60px; flex-shrink: 0;
        }
        .nav-btn:hover { color: var(--text-main); }
        .nav-btn.active { background: var(--primary); color: #0b0e14; box-shadow: 0 4px 15px rgba(45, 212, 191, 0.3); }
        .nav-btn i { font-size: 1.2rem; }
        
        .nav-add-btn {
            background: var(--primary); color: #000; border: none;
            width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; cursor: pointer; margin: 0 5px;
            box-shadow: 0 5px 20px rgba(45, 212, 191, 0.3);
            transition: transform 0.2s;
        }
        .nav-add-btn:hover { transform: scale(1.1); }

        /* --- COMPACT CALCULATOR MODAL --- */
        #calc-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px); animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #calc-content {
            width: 360px; max-width: 95%; background: var(--bg-body);
            border: 1px solid var(--glass-border); border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column;
            transform: scale(0.95); animation: popUp 0.2s ease-out forwards;
        }
        @keyframes popUp { to { transform: scale(1); } }
        
        .calc-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); background: rgba(255,255,255,0.03); }
        .calc-action-btn { background: none; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-close { color: var(--danger); }
        .btn-save { color: var(--primary); }
        .calc-tabs { display: flex; justify-content: center; padding: 15px 0; gap: 20px; }
        .calc-tab { color: var(--text-muted); cursor: pointer; font-weight: 600; padding-bottom: 5px; border-bottom: 2px solid transparent; font-size: 0.9rem; }
        .calc-tab.active { color: var(--text-main); border-color: var(--primary); }
        .calc-tab.active.expense-tab { border-color: var(--secondary); }
        .calc-input-area { padding: 0 20px; margin-bottom: 15px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .calc-pill-select { flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-main); outline: none; font-size: 0.85rem; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2394a3b8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 8px; }
        .calc-note-input { width: 100%; padding: 10px; background: transparent; border: none; border-bottom: 1px solid var(--glass-border); color: var(--text-main); font-size: 0.9rem; outline: none; }
        .calc-display-wrapper { padding: 10px 20px; text-align: right; }
        .calc-display { font-size: 2.5rem; font-weight: 700; font-family: 'Consolas', monospace; color: var(--text-main); }
        .calc-keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--glass-border); border-top: 1px solid var(--glass-border); }
        .key { background: rgba(30, 41, 59, 0.4); border: none; color: var(--text-main); font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 18px 0; transition: background 0.1s; }
        .key:active { background: rgba(255,255,255,0.1); }
        .key.op { background: rgba(45, 212, 191, 0.1); color: var(--primary); }
        .key.eq { background: var(--primary); color: #000; font-weight: bold; grid-row: span 2; height: 100%; }
        .key.del { color: var(--danger); }

        /* Records Date Header */
        .records-date-header {
            padding: 10px 0; font-size: 0.85rem; color: var(--text-muted); font-weight: bold; 
            border-bottom: 1px solid var(--glass-border); margin-top: 20px;
        }

        @media (max-width: 768px) {
            body { overflow-y: hidden; } /* Let main/view containers scroll */
            #app-wrapper { flex-direction: column; overflow-y: auto; }
            #sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--glass-border); position: relative; order: 1; padding: 20px; height: auto; display: none; } /* Hidden on mobile */
            #main { order: 2; height: 100%; overflow: visible; padding-bottom: 100px; }
            .report-header { padding: 15px 20px; align-items: flex-start; gap: 10px; }
            .header-top-row { flex-wrap: wrap; gap:10px; }
            .header-controls { width: 100%; justify-content: space-between; overflow-x: auto; }
            .currency-wrapper, #period-select, #year-select { flex: 1; min-width: 80px; }
            .custom-date-row { flex-direction: column; align-items: flex-start; }
            .view-container { padding: 20px 20px 120px 20px; }
            .summary-grid { grid-template-columns: 1fr; }
            .top-cats-container { height: 400px; }
            .bottom-nav { bottom: 0; left: 0; transform: none; width: 100%; border-radius: 0; justify-content: space-around; padding: 12px 10px; }
        }
    </style>
</head>
<body>

    <div id="auth-wrapper">
        
        <div class="auth-card active">
            <div class="auth-logo"><i class="fa-solid fa-wallet"></i></div>
            <div class="auth-title">Budget Pro</div>
            <div class="auth-sub">Secure Cloud Sync</div>
            
            <button class="google-btn" onclick="handleGoogleLogin()">
                <i class="fa-brands fa-google"></i> Sign in with Google
            </button>
            
            <div style="margin-top:20px; font-size:0.8rem; color:var(--text-muted);">
                Your data will be stored securely in your Google account.
            </div>
        </div>

    </div>

    <div id="app-wrapper" style="display: none;">
        
        <div id="sidebar">
            <div class="app-title"><i class="fa-solid fa-wallet"></i> Budget Pro</div>
            
            <div class="profile-header-card" style="padding:15px; margin-bottom:15px; background:rgba(255,255,255,0.02); width:100%; border:none;">
                <div style="display:flex; align-items:center; gap:10px; width:100%; position:relative; z-index:2;">
                    <img id="sidebar-avatar" src="" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--primary);">
                    <div style="text-align:left;">
                        <div id="sidebar-username" style="font-weight:700; font-size:0.9rem;">User</div>
                        <div style="font-size:0.7rem; color:var(--text-muted);">Pro Member</div>
                    </div>
                </div>
            </div>

            <div style="color: var(--text-muted); font-size: 0.8rem; line-height: 1.5; margin-top:20px;">
                Use the <strong>+</strong> button below to add transactions. <br><br>
                <em>Note: Profile & Logout are now in the bottom tabs.</em>
            </div>
        </div>

        <div id="calc-modal">
            <div id="calc-content">
                <div class="calc-header">
                    <button class="calc-action-btn btn-close" onclick="closeCalc()"><i class="fa-solid fa-xmark"></i> Cancel</button>
                    <div style="font-size:0.9rem; font-weight:600; color:var(--text-muted)" id="calc-title">New Transaction</div>
                    <button class="calc-action-btn btn-save" onclick="saveCalc()"><i class="fa-solid fa-check"></i> Save</button>
                </div>
                
                <div class="calc-tabs">
                    <div class="calc-tab active expense-tab" id="tab-exp" onclick="setCalcType('expense')">EXPENSE</div>
                    <div class="calc-tab" id="tab-inc" onclick="setCalcType('income')">INCOME</div>
                </div>

                <div class="calc-input-area">
                    <div class="input-row">
                        <select id="calc-cat" class="calc-pill-select">
                            </select>
                        <select id="calc-method" class="calc-pill-select" style="flex:0.8;">
                            <option value="Card">Card</option>
                            <option value="PhonePe">PhonePe</option>
                            <option value="GPay">GPay</option>
                            <option value="Paytm">Paytm</option>
                            <option value="NetBanking">NetBanking</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                    <input type="text" id="calc-note" class="calc-note-input" placeholder="Note (e.g. Vegetables)...">
                </div>

                <div class="calc-display-wrapper">
                    <div id="calc-display" class="calc-display">0</div>
                </div>

                <div class="calc-keypad">
                    <button class="key op" onclick="calcInput('/')">Ã·</button>
                    <button class="key" onclick="calcInput('7')">7</button>
                    <button class="key" onclick="calcInput('8')">8</button>
                    <button class="key" onclick="calcInput('9')">9</button>
                    
                    <button class="key op" onclick="calcInput('*')">Ã—</button>
                    <button class="key" onclick="calcInput('4')">4</button>
                    <button class="key" onclick="calcInput('5')">5</button>
                    <button class="key" onclick="calcInput('6')">6</button>
                    
                    <button class="key op" onclick="calcInput('-')">-</button>
                    <button class="key" onclick="calcInput('1')">1</button>
                    <button class="key" onclick="calcInput('2')">2</button>
                    <button class="key" onclick="calcInput('3')">3</button>
                    
                    <button class="key op" onclick="calcInput('+')">+</button>
                    <button class="key" onclick="calcInput('.')">.</button>
                    <button class="key" onclick="calcInput('0')">0</button>
                    <button class="key del" onclick="calcInput('del')"><i class="fa-solid fa-delete-left"></i></button>
                </div>
            </div>
        </div>

        <div id="main">
            <div class="report-header">
                <div class="header-top-row">
                    <div class="report-title" id="page-title">Dashboard</div>
                    <div class="header-controls">
                        <div class="currency-wrapper">
                            <select id="currency" class="header-select" onchange="changeCurrency()">
                                <option value="USD">USD ($)</option>
                                <option value="INR">INR (â‚¹)</option>
                                <option value="EUR">EUR (â‚¬)</option>
                                <option value="GBP">GBP (Â£)</option>
                                <option value="JPY">JPY (Â¥)</option>
                                <option value="CAD">CAD (C$)</option>
                            </select>
                            <span id="loader" class="spinner" style="display:none;"></span>
                        </div>
                        
                        <select id="year-select" class="header-select" onchange="updateUI()">
                            </select>

                        <select class="header-select" id="period-select" onchange="updateUI()">
                            <option value="all">All Year</option>
                            <option value="custom">Custom Range</option>
                            <option value="week">This Week</option>
                            <option disabled>---</option>
                            <option value="0">January</option>
                            <option value="1">February</option>
                            <option value="2">March</option>
                            <option value="3">April</option>
                            <option value="4">May</option>
                            <option value="5">June</option>
                            <option value="6">July</option>
                            <option value="7">August</option>
                            <option value="8">September</option>
                            <option value="9">October</option>
                            <option value="10">November</option>
                            <option value="11" selected>December</option>
                            <option disabled>---</option>
                            <option value="q1">Q1 (Jan-Mar)</option>
                            <option value="q2">Q2 (Apr-Jun)</option>
                            <option value="q3">Q3 (Jul-Sep)</option>
                            <option value="q4">Q4 (Oct-Dec)</option>
                        </select>
                    </div>
                </div>
                
                <div id="custom-date-controls" class="custom-date-row">
                    <div class="date-input-group">
                        <span class="date-label">From</span>
                        <input type="date" id="custom-start" class="custom-date-input" onchange="updateUI()">
                    </div>
                    <div class="date-input-group">
                        <span class="date-label">To</span>
                        <input type="date" id="custom-end" class="custom-date-input" onchange="updateUI()">
                    </div>
                </div>
            </div>

            <div id="view-dashboard" class="view-container active">
                <div class="summary-grid">
                    <div class="stat-card">
                        <div class="stat-title">Income</div>
                        <div class="stat-val pos" id="total-inc">...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Spend</div>
                        <div class="stat-val neg" id="total-exp">...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Net Balance</div>
                        <div class="stat-val" id="balance">...</div>
                    </div>
                </div>

                <div class="dashboard-lower">
                    <div class="flow-container">
                        <div class="chart-header-row">
                            <div class="chart-title"><i class="fa-solid fa-chart-line"></i> Expense Flow</div>
                        </div>
                        <div id="chart-flow"></div>
                        <div id="flow-tooltip" class="flow-tooltip"></div>
                        <div id="flow-daily-container" class="flow-daily-strip"></div>
                    </div>

                    <div class="top-cats-container">
                        <div class="chart-header-row">
                            <div class="chart-title">Spending Breakdown</div>
                            <div class="chart-controls-right">
                                <select id="chart-label-mode" class="chart-label-select" onchange="updateUI()">
                                    <option value="name">Show: Name</option>
                                    <option value="value">Show: Value</option>
                                    <option value="percent">Show: %</option>
                                    <option value="all">Show: All</option>
                                </select>
                                <div class="chart-switch-group">
                                    <button class="chart-switch-btn active" onclick="switchChartType('donut', this)">Donut</button>
                                    <button class="chart-switch-btn" onclick="switchChartType('sunburst', this)">Sunburst</button>
                                </div>
                            </div>
                        </div>
                        <div id="chart-cats"></div>
                        <div id="cat-tooltip" class="chart-tooltip"></div> 
                    </div>
                </div>
            </div>

            <div id="view-records" class="view-container">
                <div class="stat-card" style="margin-bottom:20px; flex-direction:row; justify-content:space-between; align-items:center;">
                    <span class="stat-title">Total Records (Period)</span>
                    <span class="stat-val" style="color:var(--text-main)" id="records-page-total">...</span>
                </div>
                <div id="records-list-container"></div>
            </div>

            <div id="view-categories" class="view-container">
                <div class="cat-section-title">Income Categories</div>
                <div id="cat-list-income"></div>

                <div class="cat-section-title">Expense Categories</div>
                <div id="cat-list-expense"></div>
            </div>

            <div id="view-income" class="view-container">
                <div class="stat-card" style="margin-bottom:20px; flex-direction:row; justify-content:space-between; align-items:center;">
                    <span class="stat-title">Total Income (Period)</span>
                    <span class="stat-val pos" id="income-page-total">...</span>
                </div>
                <div id="income-list-container"></div>
            </div>

            <div id="view-expenses" class="view-container">
                <div class="stat-card" style="margin-bottom:20px; flex-direction:row; justify-content:space-between; align-items:center;">
                    <span class="stat-title">Total Expenses (Period)</span>
                    <span class="stat-val neg" id="expense-page-total">...</span>
                </div>
                <div id="expense-list-container"></div>
            </div>

            <div id="view-profile" class="view-container">
                <div class="profile-container">
                    
                    <div class="profile-header-card">
                        <img id="main-profile-avatar" src="" class="profile-img-lg">
                        <div class="profile-name-lg" id="main-profile-name">User</div>
                        <div class="profile-badge-lg"><i class="fa-solid fa-circle-check"></i> Pro Member</div>
                        
                        <div class="profile-stats-grid">
                            <div class="p-stat-box">
                                <div class="p-stat-num" id="profile-total-tx">0</div>
                                <div class="p-stat-lbl">Transactions</div>
                            </div>
                            <div class="p-stat-box">
                                <div class="p-stat-num" style="color:var(--primary);">CLOUD</div>
                                <div class="p-stat-lbl">Storage</div>
                            </div>
                        </div>
                    </div>

                    <div style="background:rgba(45, 212, 191, 0.1); color:var(--primary); padding:15px; border-radius:12px; font-size:0.85rem; border:1px solid rgba(45, 212, 191, 0.3); margin-bottom:20px; width:100%; display:flex; gap:10px; align-items:center;">
                        <i class="fa-solid fa-cloud"></i>
                        <div>
                            <strong>GOOGLE SYNC ENABLED</strong><br>
                            Your data is backed up to your account.
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-btn" onclick="exportData()">
                            <span><i class="fa-solid fa-file-csv" style="margin-right:10px; color:#10b981"></i> Export to Excel</span>
                            <i class="fa-solid fa-download" style="font-size:0.8rem; color:var(--text-muted)"></i>
                        </div>
                        <div class="settings-btn" onclick="resetData()">
                            <span><i class="fa-solid fa-rotate-left" style="margin-right:10px; color:var(--secondary)"></i> Clear All Data</span>
                            <i class="fa-solid fa-chevron-right" style="font-size:0.8rem; color:var(--text-muted)"></i>
                        </div>
                        <div class="settings-btn danger" onclick="handleLogout()">
                            <span><i class="fa-solid fa-arrow-right-from-bracket" style="margin-right:10px;"></i> Logout</span>
                            <i class="fa-solid fa-chevron-right" style="font-size:0.8rem;"></i>
                        </div>
                    </div>

                </div>
            </div>

            <nav class="bottom-nav">
                <button class="nav-btn active" onclick="switchTab('dashboard', this)">
                    <i class="fa-solid fa-chart-pie"></i> Dash
                </button>
                <button class="nav-btn" onclick="switchTab('records', this)">
                    <i class="fa-solid fa-list"></i> Records
                </button>
                
                <button class="nav-add-btn" onclick="openCalc()">
                    <i class="fa-solid fa-plus"></i>
                </button>

                <button class="nav-btn" onclick="switchTab('categories', this)">
                    <i class="fa-solid fa-tags"></i> Cats
                </button>

                <button class="nav-btn" onclick="switchTab('profile', this)">
                    <i class="fa-solid fa-user-circle"></i> Profile
                </button>
            </nav>
        </div>
    </div>

<script>
    // --- 1. FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBg10pA9GtC56C3XR4Fg4fxSzfJbdE83_U",
        authDomain: "mahira-d7381.firebaseapp.com",
        projectId: "mahira-d7381",
        storageBucket: "mahira-d7381.firebasestorage.app",
        messagingSenderId: "133863322272",
        appId: "1:133863322272:web:b9e1ff1b4662a74b4f0fc5"
    };

    // --- 2. FIREBASE LOGIC ---
    let auth, db, currentUserUID;
    
    // Listen for custom event from the module script to know modules are ready
    window.addEventListener('firebase-modules-loaded', () => {
        initFirebase();
    });

    async function initFirebase() {
        try {
            // Use the global window.firebaseModules object populated by the module script
            const app = window.firebaseModules.initializeApp(firebaseConfig);
            auth = window.firebaseModules.getAuth(app);
            db = window.firebaseModules.getFirestore(app);
            
            // Listen for login state
            window.firebaseModules.onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserUID = user.uid;
                    updateProfileUI(user.displayName, user.photoURL);
                    showApp();
                    loadData(); // Load from Cloud
                } else {
                    currentUserUID = null;
                    document.getElementById('auth-wrapper').style.display = 'flex';
                    document.getElementById('app-wrapper').style.display = 'none';
                }
            });
        } catch(e) {
            console.error("Firebase Error:", e);
            alert("Firebase Error: " + e.message);
        }
    }

    // Google Login Function
    async function handleGoogleLogin() {
        const provider = new window.firebaseModules.GoogleAuthProvider();
        try {
            await window.firebaseModules.signInWithPopup(auth, provider);
        } catch (error) {
            alert("Login Failed: " + error.message);
        }
    }

    function handleLogout() {
        if(confirm("Logout from Google Account?")) {
            window.firebaseModules.signOut(auth);
            location.reload();
        }
    }

    function updateProfileUI(name, photo) {
        const safeName = name || "User";
        const safePhoto = photo || `https://ui-avatars.com/api/?name=${safeName}&background=2dd4bf&color=0b0e14&bold=true`;
        
        document.getElementById('sidebar-username').innerText = safeName;
        document.getElementById('sidebar-avatar').src = safePhoto;
        
        document.getElementById('main-profile-name').innerText = safeName;
        document.getElementById('main-profile-avatar').src = safePhoto;
    }

    function showApp() {
        document.getElementById('auth-wrapper').style.display = 'none';
        const app = document.getElementById('app-wrapper');
        app.style.display = 'flex';
        if(window.innerWidth < 768) app.style.flexDirection = 'column';
        initDateControls();
        window.addEventListener('resize', () => { if(currentTab==='dashboard') updateUI(); });
    }

    // --- DATA LOGIC (CLOUD) ---
    async function loadData() {
        if(!currentUserUID) return;
        
        document.getElementById('loader').style.display = 'inline-block';
        try {
            const docRef = window.firebaseModules.doc(db, "users", currentUserUID);
            const docSnap = await window.firebaseModules.getDoc(docRef);
            
            if (docSnap.exists()) {
                // FIXED: Now saves to global window variable
                window.transactions = docSnap.data().transactions || [];
            } else {
                generateDummyData(); // First time login
            }
        } catch (e) {
            console.error("Load Error", e);
        }
        document.getElementById('loader').style.display = 'none';
        initCurrency();
        updateUI();
    }

    async function saveData() {
        // Optimistic UI Update (Update screen first)
        updateUI(); 
        
        // Background Cloud Save
        if(currentUserUID) {
            try {
                await window.firebaseModules.setDoc(window.firebaseModules.doc(db, "users", currentUserUID), { 
                    transactions: transactions,
                    lastUpdated: new Date()
                });
                console.log("Cloud Saved");
            } catch(e) {
                console.error("Save Failed", e);
                // Silent fail or alert("Cloud Save Failed. Check console.");
            }
        }
    }

    function resetData() {
        if(confirm("Are you sure? This will delete all data from the Cloud.")) {
            transactions = [];
            saveData();
        }
    }

    // --- THEME DATA & HELPERS ---
    const expCategories = ["Groceries", "Dining Out", "Fuel", "Transport", "Utilities", "Shopping", "Entertainment", "Health", "Bills", "Education", "Other"];
    const incCategories = ["Salary", "Bonus", "Investment", "Gift", "Sale", "Lottery", "Other"];
    let currentChartType = 'donut';

    function getCategoryIcon(text) {
        const lower = text.toLowerCase();
        if(lower.includes("fuel")||lower.includes("gas")) return "fa-gas-pump";
        if(lower.includes("car")||lower.includes("uber")||lower.includes("transport")) return "fa-car";
        if(lower.includes("food")||lower.includes("dining")) return "fa-utensils";
        if(lower.includes("coffee")) return "fa-mug-hot";
        if(lower.includes("grocer")||lower.includes("shop")||lower.includes("sale")) return "fa-basket-shopping";
        if(lower.includes("rent")||lower.includes("home")) return "fa-house";
        if(lower.includes("electric")||lower.includes("power")||lower.includes("bill")) return "fa-bolt";
        if(lower.includes("water")) return "fa-faucet";
        if(lower.includes("net")||lower.includes("wifi")) return "fa-wifi";
        if(lower.includes("salary")||lower.includes("income")||lower.includes("lottery")||lower.includes("invest")) return "fa-money-bill-wave";
        if(lower.includes("health")||lower.includes("medic")) return "fa-heart-pulse";
        if(lower.includes("entertain")||lower.includes("movie")) return "fa-film";
        if(lower.includes("educat")) return "fa-graduation-cap";
        if(lower.includes("business")) return "fa-briefcase";
        if(lower.includes("gift")) return "fa-gift";
        return "fa-tag"; 
    }

    // --- CURRENCY ---
    const API_URL = "https://open.er-api.com/v6/latest/USD";
    let exchangeRates = { USD: 1 };
    let currentCurrency = "USD";
    let currentRate = 1;
    const symbols = { USD: "$", INR: "â‚¹", EUR: "â‚¬", GBP: "Â£", JPY: "Â¥", CAD: "C$" };

    async function initCurrency() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            if(data.result === "success") exchangeRates = data.rates;
        } catch(e) { exchangeRates = { USD:1, INR: 83.5, EUR: 0.92 }; }
        
        const savedCurr = localStorage.getItem('budget_currency_pref');
        if(savedCurr && exchangeRates[savedCurr]) {
            currentCurrency = savedCurr;
        }
        document.getElementById('currency').value = currentCurrency;
        updateRate();
    }

    function changeCurrency() {
        currentCurrency = document.getElementById('currency').value;
        localStorage.setItem('budget_currency_pref', currentCurrency);
        updateRate();
    }

    function updateRate() { 
        currentRate = exchangeRates[currentCurrency] || 1; 
        updateUI(); 
    }

    function formatMoney(amountInUSD) {
        const converted = amountInUSD * currentRate;
        const sym = symbols[currentCurrency] || "$";
        return sym + converted.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    function formatCompactMoney(amountInUSD) {
        let val = amountInUSD * currentRate;
        const sym = symbols[currentCurrency] || "$";
        if(val >= 1000000) return sym + (val/1000000).toFixed(1) + "m";
        if(val >= 1000) return sym + (val/1000).toFixed(1) + "k";
        return sym + val.toFixed(0);
    }

    // --- CORE LOGIC ---
    window.transactions = [];
    let currentTab = 'dashboard';
    let editingId = null;

    function initDateControls() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        
        const yearSel = document.getElementById('year-select');
        yearSel.innerHTML = "";
        for(let y = yyyy - 2; y <= yyyy + 5; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            if(y === yyyy) opt.selected = true;
            yearSel.appendChild(opt);
        }

        document.getElementById('period-select').value = String(today.getMonth());
        document.getElementById('custom-start').value = `${yyyy}-${mm}-01`;
        document.getElementById('custom-end').value = today.toLocaleDateString('en-CA');
    }

    function generateDummyData() {
        transactions = [];
        const today = new Date();
        const methods = ["Card", "PhonePe", "GPay", "Paytm", "NetBanking", "Cash"];
        
        for(let i=60; i>=0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const dateStr = d.toLocaleDateString('en-CA'); 
            const randMethod = methods[Math.floor(Math.random()*methods.length)];

            if(i % 14 === 0) transactions.push({id: Date.now()+i, date: dateStr, desc: "Salary", amount: 4000, type: "income", method: "NetBanking"});
            
            const amt = Math.floor(Math.random() * 150) + 20;
            const cats = ["Groceries", "Transport", "Dining Out", "Coffee", "Utilities", "Entertainment", "Shopping"];
            const cat = cats[Math.floor(Math.random() * cats.length)];
            const sub = ["", "(Milk)", "(Uber)", "(Movie)", "(Bill)", "(Vegetables)"][Math.floor(Math.random()*6)];
            transactions.push({id: Date.now()+i+1, date: dateStr, desc: cat + (sub ? " " + sub : ""), amount: amt, type: "expense", method: randMethod});
        }
        saveData();
    }

    function switchTab(tabName, btn) {
        currentTab = tabName;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.add('active');
        
        const titles = { 'dashboard': 'Dashboard', 'income': 'Income Details', 'expenses': 'Expense Details', 'records': 'All Records', 'categories': 'Categories', 'profile': 'My Profile' };
        document.getElementById('page-title').innerText = titles[tabName] || 'Budget Pro';
        updateUI();
    }

    function deleteTx(id) {
        if(confirm("Delete entry?")) transactions = transactions.filter(t => t.id !== id);
        saveData();
    }

    // --- REPAIRED EDIT FUNCTION ---
    function editTx(id) {
        const tx = transactions.find(t => t.id === id);
        if(!tx) return;
        editingId = id; 
        openCalc(true); 
        setCalcType(tx.type);
        
        let catName = tx.desc;
        if (tx.desc.includes('(')) {
            catName = tx.desc.split('(')[0].trim();
        }
        document.getElementById('calc-cat').value = catName;

        if(tx.method) document.getElementById('calc-method').value = tx.method;
        
        let note = "";
        if(tx.desc.includes('(')) {
            const match = tx.desc.match(/\(([^)]*)\)/); 
            if (match && match[1]) {
                note = match[1];
            }
        }
        document.getElementById('calc-note').value = note;
        
        calcString = (tx.amount * currentRate).toFixed(2);
        updateCalcDisplay();
    }

    // --- CALCULATOR ---
    let calcString = "0";
    let calcType = "expense";

    function openCalc(isEdit = false) {
        document.getElementById('calc-modal').style.display = 'flex';
        document.getElementById('calc-title').innerText = isEdit ? "Edit Transaction" : "New Transaction";
        if(!isEdit) {
            editingId = null; setCalcType('expense'); calcString = "0";
            document.getElementById('calc-note').value = ""; updateCalcDisplay();
        }
    }

    function closeCalc() { document.getElementById('calc-modal').style.display = 'none'; editingId = null; }

    function setCalcType(type) {
        calcType = type;
        document.getElementById('tab-exp').classList.toggle('active', type === 'expense');
        document.getElementById('tab-inc').classList.toggle('active', type === 'income');
        const select = document.getElementById('calc-cat');
        const currentVal = select.value;
        select.innerHTML = "";
        const list = type === 'expense' ? expCategories : incCategories;
        list.forEach(c => {
            const opt = document.createElement('option'); opt.value = c; opt.innerText = c; select.appendChild(opt);
        });
        if(list.includes(currentVal)) select.value = currentVal;
    }

    function calcInput(val) {
        if(val === 'del') { calcString = calcString.slice(0, -1); if(calcString === "") calcString = "0"; }
        else if (['+','-','*','/'].includes(val)) {
            const last = calcString.slice(-1);
            if(['+','-','*','/'].includes(last)) calcString = calcString.slice(0, -1) + val; else calcString += val;
        } else {
            if(calcString === "0" && val !== '.') calcString = val; else calcString += val;
        }
        updateCalcDisplay();
    }

    function calcEval() {
        try {
            if(/[^0-9+\-*/.]/.test(calcString)) return; 
            const result = new Function('return ' + calcString)();
            calcString = parseFloat(result.toFixed(2)).toString();
            updateCalcDisplay();
        } catch(e) { calcString = "Error"; updateCalcDisplay(); }
    }

    function updateCalcDisplay() {
        document.getElementById('calc-display').innerText = calcString;
        document.getElementById('calc-display').style.color = calcType === 'income' ? 'var(--primary)' : 'var(--secondary)';
    }

    function saveCalc() {
        calcEval(); 
        const amount = parseFloat(calcString);
        
        if(isNaN(amount) || amount <= 0) { 
            alert("Please enter a valid amount greater than 0"); 
            return; 
        }
        
        const cat = document.getElementById('calc-cat').value;
        const method = document.getElementById('calc-method').value;
        const note = document.getElementById('calc-note').value.trim();
        const desc = note ? `${cat} (${note})` : cat;
        const amtUSD = amount / currentRate;

        if(editingId) {
            const idx = transactions.findIndex(t => t.id === editingId);
            if(idx > -1) transactions[idx] = { ...transactions[idx], desc, amount: amtUSD, type: calcType, method };
        } else {
            const dateStr = new Date().toLocaleDateString('en-CA');
            transactions.push({ id: Date.now(), date: dateStr, desc: desc, amount: amtUSD, type: calcType, method: method });
        }
        saveData(); closeCalc();
    }

    // --- FILTER ---
    function filterData() {
        const year = parseInt(document.getElementById('year-select').value);
        const period = document.getElementById('period-select').value;
        const customStart = document.getElementById('custom-start').value;
        const customEnd = document.getElementById('custom-end').value;

        const customRow = document.getElementById('custom-date-controls');
        if(period === 'custom') customRow.classList.add('show'); else customRow.classList.remove('show');

        return transactions.filter(t => {
            const txDate = new Date(t.date);
            const txY = txDate.getFullYear();
            const txM = txDate.getMonth();
            
            if(period === 'custom') {
                if(!customStart || !customEnd) return true;
                return t.date >= customStart && t.date <= customEnd;
            }
            if(period === 'week') {
                const now = new Date();
                const day = now.getDay() || 7; 
                if(day !== 1) now.setHours(-24 * (day - 1));
                const startOfWeek = new Date(now); 
                startOfWeek.setHours(0,0,0,0);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                endOfWeek.setHours(23,59,59,999);
                return txDate >= startOfWeek && txDate <= endOfWeek;
            }
            if(txY !== year) return false;
            if(period === 'all') return true;
            if(period === 'q1') return txM >= 0 && txM <= 2;
            if(period === 'q2') return txM >= 3 && txM <= 5;
            if(period === 'q3') return txM >= 6 && txM <= 8;
            if(period === 'q4') return txM >= 9 && txM <= 11;
            const monthIdx = parseInt(period);
            if(!isNaN(monthIdx)) return txM === monthIdx;
            return true;
        });
    }

    // --- UI RENDERING ---
    function updateUI() {
        const filtered = filterData();
        
        let inc=0, exp=0;
        filtered.forEach(t => t.type === 'income' ? inc += t.amount : exp += t.amount);
        document.getElementById('total-inc').innerText = formatMoney(inc);
        document.getElementById('total-exp').innerText = formatMoney(exp);
        document.getElementById('balance').innerText = formatMoney(inc - exp);
        
        document.getElementById('profile-total-tx').innerText = filtered.length;

        if(currentTab === 'dashboard') {
            renderExpenseFlow(filtered);
            if(currentChartType === 'donut') renderSpendingDonut(filtered);
            else renderSpendingSunburst(filtered);
        } else if (currentTab === 'records') renderRecordsList(filtered);
        else if (currentTab === 'income') renderDetailList(filtered, 'income');
        else if (currentTab === 'expenses') renderDetailList(filtered, 'expense');
        else if (currentTab === 'categories') renderCategories(filtered);
    }

    function switchChartType(type, btn) {
        currentChartType = type;
        document.querySelectorAll('.chart-switch-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateUI();
    }

    // --- CHART RENDERERS ---

    function renderExpenseFlow(data) {
        const container = document.getElementById('chart-flow');
        container.innerHTML = "";
        
        const dateMap = {};
        data.filter(t => t.type === 'expense').forEach(t => {
            const val = t.amount * currentRate;
            dateMap[t.date] = (dateMap[t.date] || 0) + val;
        });

        const sortedDates = Object.keys(dateMap).sort();
        if(sortedDates.length === 0) {
            container.innerHTML = "<div style='text-align:center; color:var(--text-muted); padding-top:80px;'>No expense data</div>";
            document.getElementById('flow-daily-container').innerHTML = "";
            return; 
        }

        const chartData = sortedDates.map(date => ({ date: new Date(date), val: dateMap[date] }));
        const width = container.clientWidth;
        const height = container.clientHeight;
        const margin = {top: 10, right: 10, bottom: 20, left: 30};

        const svg = d3.select("#chart-flow").append("svg")
            .attr("width", width).attr("height", height);

        const x = d3.scaleTime().domain(d3.extent(chartData, d => d.date)).range([margin.left, width - margin.right]);
        const y = d3.scaleLinear().domain([0, d3.max(chartData, d => d.val) * 1.1]).range([height - margin.bottom, margin.top]);

        const defs = svg.append("defs");
        const gradient = defs.append("linearGradient").attr("id", "area-gradient").attr("x1", "0%").attr("y1", "0%").attr("x2", "0%").attr("y2", "100%");
        gradient.append("stop").attr("offset", "0%").attr("stop-color", "var(--danger)").attr("stop-opacity", 0.5);
        gradient.append("stop").attr("offset", "100%").attr("stop-color", "var(--danger)").attr("stop-opacity", 0);

        const area = d3.area().curve(d3.curveMonotoneX).x(d => x(d.date)).y0(height - margin.bottom).y1(d => y(d.val));
        const line = d3.line().curve(d3.curveMonotoneX).x(d => x(d.date)).y(d => y(d.val));

        svg.append("path").datum(chartData).attr("fill", "url(#area-gradient)").attr("d", area);
        svg.append("path").datum(chartData).attr("fill", "none").attr("stroke", "var(--danger)").attr("stroke-width", 2).attr("d", line);

        const tooltip = document.getElementById('flow-tooltip');
        
        svg.selectAll(".dot").data(chartData).enter().append("circle")
            .attr("cx", d => x(d.date)).attr("cy", d => y(d.val)).attr("r", 5)
            .attr("fill", "var(--bg-body)").attr("stroke", "var(--danger)").attr("stroke-width", 2)
            .style("cursor", "pointer")
            .on("mouseover", function(event, d) {
                d3.select(this).attr("r", 8).attr("fill", "var(--danger)");
                tooltip.style.opacity = 1;
                tooltip.innerHTML = `<strong>${d.date.toLocaleDateString()}</strong><br>${formatMoney(d.val / currentRate)}`; 
                
                const [mx, my] = d3.pointer(event, document.querySelector('.flow-container'));
                tooltip.style.left = `${mx}px`;
                tooltip.style.top = `${my - 40}px`;
            })
            .on("mouseout", function() {
                d3.select(this).attr("r", 5).attr("fill", "var(--bg-body)");
                tooltip.style.opacity = 0;
            });

        const strip = document.getElementById('flow-daily-container');
        strip.innerHTML = "";
        [...chartData].reverse().forEach(d => {
            const div = document.createElement('div');
            div.className = 'flow-daily-item';
            div.innerHTML = `<div class="flow-day">${d.date.toLocaleDateString('en-US', { weekday: 'short' })}</div><div class="flow-date">${d.date.getDate()}</div><div class="flow-amt">${formatCompactMoney(d.val / currentRate)}</div>`;
            strip.appendChild(div);
        });
    }

    function relaxLabels(labels, spacing) {
        let right = labels.filter(l => l.pos[0] > 0).sort((a,b) => a.pos[1] - b.pos[1]);
        let left = labels.filter(l => l.pos[0] < 0).sort((a,b) => a.pos[1] - b.pos[1]);
        function relaxSide(group) {
            for(let i=0; i<group.length; i++) {
                if(i > 0) {
                    let prev = group[i-1];
                    if(group[i].pos[1] < prev.pos[1] + spacing) {
                        group[i].pos[1] = prev.pos[1] + spacing;
                    }
                }
            }
        }
        relaxSide(right); relaxSide(left);
    }

    function getLabelText(name, value, total) {
        const mode = document.getElementById('chart-label-mode').value;
        const percent = ((value / total) * 100).toFixed(1) + "%";
        const valStr = formatCompactMoney(value / currentRate); 
        if(mode === 'value') return valStr;
        if(mode === 'percent') return percent;
        if(mode === 'all') return `${name}: ${valStr} (${percent})`;
        return name; 
    }

    function renderSpendingDonut(data) {
        const container = document.getElementById('chart-cats');
        const tooltip = document.getElementById('cat-tooltip');
        container.innerHTML = ""; container.appendChild(tooltip);
        const map = {}; data.filter(t => t.type==='expense').forEach(t => { const val = t.amount * currentRate; let catName = t.desc.split('(')[0].trim(); map[catName] = (map[catName] || 0) + val; });
        const sorted = Object.keys(map).map(k => ({name:k, val:map[k]})).sort((a,b) => b.val - a.val).slice(0, 7);
        if(sorted.length===0) { container.innerHTML += "<div style='color:#64748b;text-align:center;padding-top:150px;'>No expenses</div>"; return; }
        const total = sorted.reduce((a,b)=>a+b.val,0);
        const w = container.clientWidth || 300; const h = Math.max(container.clientHeight, 400) - 20; 
        const r = Math.min(w, h)/2; const radius = r * 0.7;
        const svg = d3.select("#chart-cats").append("svg").attr("width", w).attr("height", h).append("g").attr("transform", `translate(${w/2},${h/2})`);
        const rootStyles = getComputedStyle(document.documentElement);
        const colors = d3.scaleOrdinal([rootStyles.getPropertyValue('--danger').trim(), "var(--secondary)", "#a855f7", "#3b82f6", "var(--primary)", "#f97316", "#10b981"]);
        const pie = d3.pie().value(d => d.val).sort(null);
        const arc = d3.arc().innerRadius(radius*0.6).outerRadius(radius).cornerRadius(5);
        const outerArc = d3.arc().innerRadius(radius * 1.1).outerRadius(radius * 1.1);
        const centerName = svg.append("text").attr("class", "donut-label").attr("dy", "-0.5em").attr("text-anchor","middle").style("font-size","12px").style("fill", "var(--text-muted)").text("Top Spend");
        const centerVal = svg.append("text").attr("class", "donut-val").attr("dy", "1em").attr("text-anchor","middle").style("font-size","20px").style("fill", "var(--text-main)").style("font-weight","bold").text(formatCompactMoney(total / currentRate));
        const arcs = svg.selectAll('g.slice').data(pie(sorted)).enter().append('g').attr('class','slice');
        arcs.append('path').attr('d', arc).attr('fill', (d,i) => colors(i)).style("stroke", "var(--bg-body)").style("stroke-width", "3px")
            .on('mouseover', (e, d) => { const sym = symbols[currentCurrency] || "$"; centerName.text(d.data.name); centerVal.text(formatCompactMoney(d.data.val / currentRate)); centerVal.style("fill", colors(d.index)); })
            .on('mouseout', () => { centerName.text("Total"); centerVal.text(formatCompactMoney(total / currentRate)); centerVal.style("fill", "var(--text-main)"); });
        const pieData = pie(sorted);
        const labelData = pieData.map(d => {
            const pos = outerArc.centroid(d);
            const midAngle = d.startAngle + (d.endAngle - d.startAngle) / 2;
            pos[0] = radius * 1.2 * (midAngle < Math.PI ? 1 : -1); 
            return { d: d, pos: pos, midAngle: midAngle };
        });
        relaxLabels(labelData, 14);
        const labelGroup = svg.append("g").attr("class", "labels");
        const lineGroup = svg.append("g").attr("class", "lines");
        labelGroup.selectAll("text").data(labelData).enter().append("text").attr("dy", ".35em").attr("class", "slice-label").text(item => getLabelText(item.d.data.name, item.d.data.val, total)).attr("transform", item => `translate(${item.pos})`).style("text-anchor", item => item.midAngle < Math.PI ? "start" : "end");
        lineGroup.selectAll("polyline").data(labelData).enter().append("polyline").attr("class", "slice-line").attr("points", item => { const inner = arc.centroid(item.d); const mid = outerArc.centroid(item.d); return [inner, mid, item.pos]; });
    }

    function renderSpendingSunburst(data) {
        const container = document.getElementById('chart-cats');
        const tooltip = document.getElementById('cat-tooltip');
        container.innerHTML = ""; container.appendChild(tooltip);
        
        const isMobile = window.innerWidth < 768;

        const rootData = { name: "root", children: [] };
        const catMap = {};

        data.filter(t => t.type==='expense').forEach(t => {
            const val = t.amount * currentRate;
            let catName = t.desc.split('(')[0].trim();
            let subName = t.desc.includes('(') ? t.desc.match(/\(([^)]+)\)/)[1] : t.desc;
            if(subName === catName) subName = "General";
            if(!catMap[catName]) catMap[catName] = [];
            catMap[catName].push({ name: subName, value: val });
        });

        for(const [key, value] of Object.entries(catMap)) {
            const subMap = {};
            value.forEach(v => subMap[v.name] = (subMap[v.name] || 0) + v.value);
            const children = Object.keys(subMap).map(k => ({ name: k, value: subMap[k] }));
            rootData.children.push({ name: key, children: children });
        }

        if(rootData.children.length === 0) { container.innerHTML += "<div style='color:#64748b;text-align:center;padding-top:150px;'>No expenses</div>"; return; }

        const w = container.clientWidth || 300; 
        const h = Math.max(container.clientHeight, 400) - 20; 
        
        const maxRadius = Math.min(w, h) / 2;
        const radius = maxRadius - (isMobile ? 65 : 80); 

        const svg = d3.select("#chart-cats").append("svg")
            .attr("width", w).attr("height", h)
            .append("g").attr("transform", `translate(${w/2},${h/2})`);

        const partition = d3.partition().size([2 * Math.PI, radius]);
        const root = d3.hierarchy(rootData).sum(d => d.value).sort((a, b) => b.value - a.value);

        partition(root);

        const arc = d3.arc()
            .startAngle(d => d.x0)
            .endAngle(d => d.x1)
            .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
            .padRadius(radius / 2)
            .innerRadius(d => {
                if(d.depth === 1) return radius * 0.6; // Inner ring starts at 60%
                return radius * 0.92; // Outer ring starts at 92% (Leaves)
            })
            .outerRadius(d => {
                if(d.depth === 1) return radius * 0.9; 
                return radius; 
            });
            
        const labelRadiusStr = isMobile ? 1.05 : 1.15;
        const outerArc = d3.arc().innerRadius(radius * labelRadiusStr).outerRadius(radius * labelRadiusStr);
        const color = d3.scaleOrdinal(d3.schemeSpectral[10]);

        const centerName = svg.append("text").attr("dy", "-0.5em").attr("text-anchor","middle").style("font-size","12px").style("fill", "var(--text-muted)").text("Total");
        const centerVal = svg.append("text").attr("dy", "1em").attr("text-anchor","middle").style("font-size","18px").style("fill", "var(--text-main)").style("font-weight","bold")
            .text(formatCompactMoney(root.value / currentRate));

        svg.selectAll("path")
            .data(root.descendants().filter(d => d.depth)) 
            .enter().append("path")
            .attr("fill", d => { while (d.depth > 1) d = d.parent; return color(d.data.name); })
            .attr("fill-opacity", d => d.children ? 0.8 : 0.6)
            .attr("d", arc)
            .style("stroke", "var(--bg-body)").style("stroke-width", "1px")
            .on("mouseover", function(event, d) {
                const sym = symbols[currentCurrency] || "$";
                centerName.text(d.data.name); 
                centerVal.text(formatCompactMoney(d.value / currentRate));
                d3.select(this).style("fill-opacity", 1);
            })
            .on("mouseout", function() {
                centerName.text("Total"); centerVal.text(formatCompactMoney(root.value / currentRate));
                d3.selectAll("path").style("fill-opacity", d => d.children ? 0.8 : 0.6);
            });
            
        svg.selectAll(".label-inner")
            .data(root.descendants().filter(d => d.depth === 1))
            .enter().append("text")
            .attr("class", "slice-label-inner")
            .attr("transform", function(d) { return `translate(${arc.centroid(d)})`; })
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .text(d => (d.x1 - d.x0) > 0.15 ? d.data.name : "");

        const outerNodes = root.descendants().filter(d => d.depth === 2 && (d.x1 - d.x0) > 0.05); 
        
        const labelData = outerNodes.map(d => {
            const angle = d.x0 + (d.x1 - d.x0) / 2;
            const R = radius * (isMobile ? 1.1 : 1.25); 
            const x = R * Math.sin(angle);
            const y = -R * Math.cos(angle);
            const pos = [x, y];
            pos[0] = R * (x >= 0 ? (isMobile ? 1 : 1.1) : (isMobile ? -1 : -1.1));
            return { d: d, pos: pos, angle: angle };
        });

        relaxLabels(labelData, isMobile ? 12 : 14); 

        const labelGroup = svg.append("g").attr("class", "labels");
        const lineGroup = svg.append("g").attr("class", "lines");

        labelGroup.selectAll("text")
            .data(labelData)
            .enter().append("text")
            .attr("dy", ".35em")
            .attr("class", "slice-label")
            .style("font-size", isMobile ? "9px" : "11px") 
            .text(item => getLabelText(item.d.data.name, item.d.value, root.value))
            .attr("transform", item => `translate(${item.pos})`)
            .style("text-anchor", item => item.pos[0] > 0 ? "start" : "end");

        lineGroup.selectAll("polyline")
            .data(labelData)
            .enter().append("polyline")
            .attr("class", "slice-line")
            .attr("points", item => {
                const c = arc.centroid(item.d);
                const angle = item.angle; 
                const R_mid = radius * (isMobile ? 1.02 : 1.1); 
                const x_mid = R_mid * Math.sin(angle);
                const y_mid = -R_mid * Math.cos(angle);
                return [c, [x_mid, y_mid], item.pos];
            });
    }

    function renderCategories(data) {
        const catMap = {}; data.forEach(t => { let catName = t.desc.split('(')[0].trim(); if(!catMap[catName]) catMap[catName] = { amount: 0, count: 0 }; catMap[catName].amount += t.amount; });
        const renderList = (cats, divId, color, type) => {
            const container = document.getElementById(divId); let html = '';
            cats.forEach(c => {
                const icon = getCategoryIcon(c);
                const typeSubset = data.filter(t => t.type === type && t.desc.startsWith(c));
                const total = typeSubset.reduce((acc, t) => acc + t.amount, 0);
                const count = typeSubset.length;
                const displayAmt = total > 0 ? formatMoney(total) : "";
                const displayCount = count > 0 ? `${count} txns` : "";
                const valColor = total > 0 ? color : "var(--text-muted)";
                html += `<div class="cat-list-item"><div class="cat-left"><div class="cat-icon-circle" style="background:rgba(255,255,255,0.05); color:${color}"><i class="fa-solid ${icon}"></i></div><div class="cat-name">${c}</div></div><div class="cat-right"><div class="cat-amount" style="color:${valColor}">${displayAmt || "-"}</div><div class="cat-count">${displayCount}</div></div></div>`;
            });
            container.innerHTML = html;
        };
        renderList(incCategories, 'cat-list-income', 'var(--primary)', 'income');
        renderList(expCategories, 'cat-list-expense', 'var(--secondary)', 'expense');
    }

    function renderRecordsList(data) {
        const container = document.getElementById('records-list-container'); data.sort((a,b) => new Date(b.date) - new Date(a.date)); document.getElementById('records-page-total').innerText = data.length + " items";
        if(data.length === 0) { container.innerHTML = `<div class="empty-state">No records found.</div>`; return; }
        let html = ''; let lastDate = '';
        data.forEach(t => {
            if(t.date !== lastDate) { const niceDate = new Date(t.date).toLocaleDateString(undefined, {weekday:'long', month:'short', day:'numeric'}); html += `<div class="records-date-header">${niceDate}</div>`; lastDate = t.date; }
            const icon = getCategoryIcon(t.desc); const color = t.type === 'income' ? 'var(--primary)' : 'var(--danger)'; const sign = t.type === 'income' ? '+' : '-'; const methodDisplay = t.method ? `<span class="method-tag">${t.method}</span>` : '';
            html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid rgba(255,255,255,0.03);"><div style="display:flex; align-items:center;"><span class="detail-icon" style="color:${color}"><i class="fa-solid ${icon}"></i></span><div><div style="font-weight:600; font-size:0.95rem;">${t.desc}</div><div style="display:flex; align-items:center; margin-top:3px;"><div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">${t.type}</div>${methodDisplay}</div></div></div><div style="text-align:right;"><div style="font-weight:700; color:${color}">${sign}${formatMoney(t.amount)}</div><div style="display:flex; gap:10px; justify-content:flex-end; margin-top:5px;"><div style="font-size:0.9rem; color:var(--text-muted); cursor:pointer;" onclick="editTx(${t.id})"><i class="fa-solid fa-pen"></i></div><div style="font-size:0.9rem; color:var(--text-muted); cursor:pointer;" onclick="deleteTx(${t.id})"><i class="fa-solid fa-trash"></i></div></div></div></div>`;
        });
        container.innerHTML = html;
    }

    function renderDetailList(data, type) {
        const container = document.getElementById(type === 'income' ? 'income-list-container' : 'expense-list-container'); const subset = data.filter(t => t.type === type).sort((a,b) => new Date(b.date) - new Date(a.date));
        if(subset.length === 0) { container.innerHTML = `<div class="empty-state">No ${type} records.</div>`; return; }
        let html = `<table class="detail-table"><thead><tr><th>Date</th><th>Description</th><th style="text-align:right">Amount</th><th style="text-align:right"></th></tr></thead><tbody>`;
        subset.forEach(t => {
            const icon = getCategoryIcon(t.desc); const methodTxt = t.method ? ` <span style="font-size:0.75rem; color:var(--text-muted)">(${t.method})</span>` : '';
            html += `<tr><td>${t.date}</td><td><span class="detail-icon"><i class="fa-solid ${icon}"></i></span> ${t.desc}${methodTxt}</td><td style="text-align:right; font-family:'Consolas'; font-weight:700; color: ${type=='income'?'var(--primary)':'var(--secondary)'}">${formatMoney(t.amount)}</td><td style="text-align:right"><button style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-right:10px;" onclick="editTx(${t.id})"><i class="fa-solid fa-pen"></i></button><button style="background:none; border:none; color:var(--text-muted); cursor:pointer;" onclick="deleteTx(${t.id})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    document.addEventListener('keydown', function(event) {
        if(document.getElementById('calc-modal').style.display === 'none') return;
        const key = event.key;
        if(/[0-9]/.test(key) || ['.','+','-','*','/'].includes(key)) { calcInput(key); }
        else if(key === 'Backspace') { calcInput('del'); }
        else if(key === 'Enter') { event.preventDefault(); saveCalc(); }
        else if(key === 'Escape') { closeCalc(); }
    });
    // --- FEATURE: EXPORT TO CSV ---
    window.exportData = function() {
        if (!window.transactions || window.transactions.length === 0) { alert("No data to export!"); return; }
        let csvContent = "Date,Description,Amount (${selectedCurrency}),Type,Method\n";
        window.transactions.forEach(t => {
            let cleanDesc = t.desc.replace(/,/g, " "); 
            let amt = (t.amount * currentRate).toFixed(2);
            let row = `${t.date},${cleanDesc},${amt},${t.type},${t.method || ''}`;
            csvContent += row + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "budget_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

</script>
</body>
</html>

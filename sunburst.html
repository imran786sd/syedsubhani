<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunburst Editor Pro v7.1 (Crash-Proof)</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-hover: #3a0ca3;
            --bg: #f4f6f8;
            --border: #e0e0e0;
            --header-bg: #f8f9fa;
            --sidebar-bg: #ffffff;
            --input-bg: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --danger: #ef233c;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-main);
            background: var(--bg);
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 460px;
            min-width: 440px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.04);
            z-index: 10;
            height: 100vh;
        }

        .tabs { display: flex; background: #fff; border-bottom: 1px solid var(--border); padding: 0; flex-shrink: 0; }
        .tab-btn {
            flex: 1; padding: 18px 0; border: none; background: transparent; cursor: pointer;
            font-weight: 600; color: var(--text-muted); border-bottom: 3px solid transparent; 
            font-size: 13px; transition: all 0.2s ease; letter-spacing: 0.3px; text-transform: uppercase;
        }
        .tab-btn:hover { color: var(--primary); background: #f8f9fa; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: rgba(67, 97, 238, 0.04); }
        #btn-json { display: none; }

        .tab-content { display: none; flex-direction: column; flex-grow: 1; overflow-y: auto; position: relative; background: #fff; padding-bottom: 20px; }
        .tab-content.active { display: flex !important; }

        #sidebar-footer { padding: 20px; border-top: 1px solid var(--border); background: white; flex-shrink: 0; z-index: 20; box-shadow: 0 -4px 10px rgba(0,0,0,0.03); }
        .update-btn-main {
            width: 100%; padding: 14px; background: var(--primary); color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3); transition: transform 0.1s, box-shadow 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .update-btn-main:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .update-btn-main:active { transform: translateY(0); }

        /* --- GRID --- */
        #tab-grid { padding: 0; background: white; height: 100%; }
        .grid-header {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 90px 60px 35px;
            background: #f1f3f5; border-bottom: 1px solid #dee2e6;
            font-size: 11px; font-weight: 700; color: #495057; text-transform: uppercase;
            letter-spacing: 0.5px; position: sticky; top: 0; z-index: 5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .grid-header span { padding: 12px 8px; border-right: 1px solid #e9ecef; text-align: left; }
        .grid-header span:last-child { border-right: none; }
        #rows-container { flex-grow: 1; }

        .data-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 90px 60px 35px; border-bottom: 1px solid #f1f3f5; transition: background 0.15s; }
        .data-row:hover { background-color: #f8f9fa; }
        .data-row:hover .del-cell { opacity: 1; color: #adb5bd; }

        .data-row input[type="text"].lvl-input { width: 100%; border: none; background: transparent; padding: 12px 8px; font-size: 12px; outline: none; border-right: 1px solid #f1f3f5; box-sizing: border-box; color: #333; }
        .data-row input.val-input { width: 100%; border: none; background: transparent; padding: 12px 8px; text-align: right; font-family: 'Consolas', monospace; color: var(--primary); font-weight: 600; font-size: 12px; border-right: 1px solid #f1f3f5; outline: none; }
        .data-row input:focus { background: white; box-shadow: inset 0 -2px 0 var(--primary); z-index: 2; }
        .color-wrapper { display: flex; align-items: center; border-right: 1px solid #f1f3f5; padding: 4px 6px; background: transparent; }
        input[type="color"] { border: none; width: 20px; height: 20px; cursor: pointer; background: none; padding: 0; border-radius: 4px; overflow: hidden; margin-right: 6px; }
        input.hex-input { width: 100%; border: none; font-family: 'Consolas', monospace; font-size: 10px; color: #666; text-transform: uppercase; outline: none; background: transparent; }
        .del-cell { display: flex; align-items: center; justify-content: center; cursor: pointer; color: #e9ecef; font-size: 18px; transition: 0.2s; opacity: 0; }
        .del-cell:hover { color: var(--danger) !important; background: #fff5f5; }

        .grid-controls { padding: 20px; background: white; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .btn-add { background: #eef2ff; color: var(--primary); border: 1px solid transparent; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 700; font-size: 13px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add:hover { background: #e0e7ff; border-color: #c7d2fe; transform: translateY(-1px); }

        .import-section { border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #fff; transition: box-shadow 0.2s; }
        .import-header { padding: 12px 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: 700; color: #555; user-select: none; }
        .import-body { padding: 15px; display: none; border-top: 1px solid #e0e0e0; background: #fcfcfc; }
        .import-body.open { display: block; }
        .import-body textarea { width: 100%; min-height: 100px; border: 1px solid #ced4da; padding: 12px; font-family: 'Consolas', monospace; font-size: 11px; margin-bottom: 12px; border-radius: 6px; box-sizing: border-box; }
        .import-help { font-size: 11px; color: #666; margin-bottom: 10px; background: #e3f2fd; padding: 8px 12px; border-radius: 4px; border-left: 3px solid #2196f3; }
        .btn-parse { width: 100%; padding: 10px; background: #495057; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; }

        /* --- SETTINGS --- */
        #tab-settings { padding: 25px 20px; gap: 20px; background: #f8f9fa; }
        #tab-json { padding: 20px; }
        .settings-card { background: white; border-radius: 12px; border: 1px solid #e9ecef; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .settings-card h3 { margin: 0 0 18px 0; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); border-bottom: 1px solid #f1f3f5; padding-bottom: 10px; font-weight: 800; }
        .control-row { margin-bottom: 15px; }
        .control-label { display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: 600; color: #343a40; margin-bottom: 8px; }
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .settings-card input[type="text"], .settings-card input[type="number"], .settings-card select { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; color: #495057; background: #fff; box-sizing: border-box; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 8px 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #e9ecef; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; -webkit-appearance: none; margin-top: -5px; }
        .range-val { font-size: 11px; color: var(--primary); font-weight: 700; background: #eef2ff; padding: 2px 8px; border-radius: 10px; }
        
        .toggle-wrapper { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #e9ecef; cursor: pointer; }
        .color-picker-group { display: flex; align-items: center; gap: 8px; }
        .color-btn { width: 36px; height: 36px; padding: 0; border: 1px solid #ced4da; border-radius: 8px; cursor: pointer; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .color-btn input { width: 150%; height: 150%; margin: -25%; cursor: pointer; }
        .sub-panel { background: #fcfcfc; border: 1px dashed #ddd; border-radius: 6px; padding: 12px; margin-top: 10px; }
        .sub-panel-title { font-size: 11px; font-weight: 700; color: #999; margin-bottom: 8px; display: block; }

        /* --- MAIN --- */
        #main { flex-grow: 1; background: var(--bg); position: relative; background-image: radial-gradient(#d1d5db 1.5px, transparent 1.5px); background-size: 24px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        #menu-container { position: absolute; top: 20px; right: 20px; z-index: 100; }
        #menu-btn { background: white; border: 1px solid #ced4da; color: #495057; width: 44px; height: 44px; border-radius: 12px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        #main-menu { display: none; position: absolute; right: 0; top: 55px; background-color: white; min-width: 200px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 12px; border: 1px solid #e9ecef; overflow: hidden; z-index: 101; padding: 6px 0; }
        #main-menu.show { display: block; }
        .menu-item { padding: 12px 20px; text-decoration: none; display: flex; align-items: center; gap: 12px; color: #495057; font-size: 13px; font-weight: 600; cursor: pointer; }
        .menu-item:hover { background-color: #f1f3f5; color: var(--primary); }
        .menu-separator { height: 1px; background: #e9ecef; margin: 6px 0; }
        .menu-item.danger { color: #e03131; }

        #chart { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 40px; box-sizing: border-box; }
        #chart svg { max-width: 100%; max-height: 100%; width: auto; height: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.12); background: white; display: block; border-radius: 16px; }
        
        .pointer-line { fill: none; stroke-linecap: round; cursor: crosshair; }
        .pointer-hit-area { fill: none; stroke: transparent; stroke-width: 15px; cursor: crosshair; }
        text.draggable { cursor: move; }
        text.draggable:hover { font-weight: 900; }
        
        .control-handle { cursor: move; stroke: var(--primary); stroke-width: 1px; fill: #4361ee; opacity: 0; transition: opacity 0.2s; }
        .line-wrapper:hover .control-handle { opacity: 1; }
        .control-handle.dragging { opacity: 1 !important; }
        .tooltip { position: absolute; background: rgba(33, 37, 41, 0.95); color: #fff; padding: 10px 14px; border-radius: 6px; font-size: 13px; pointer-events: none; opacity: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>

<div id="sidebar">
    <div class="tabs">
        <button class="tab-btn active" id="btn-grid" onclick="switchTab('grid')">Data Editor</button>
        <button class="tab-btn" id="btn-settings" onclick="switchTab('settings')">Settings</button>
        <button class="tab-btn" id="btn-json" onclick="switchTab('json')">JSON Source</button>
    </div>

    <div id="tab-grid" class="tab-content active">
        <div class="grid-header">
            <span>Level 1</span><span>Level 2</span><span>Level 3</span><span>Level 4</span><span title="Hex Code">Color</span><span style="text-align: right;">Value</span><span></span>
        </div>
        <div id="rows-container"></div>
        <div class="grid-controls">
            <button class="btn-add" onclick="addGridRow()">+ Add New Row</button>
            <div class="import-section">
                <div class="import-header" onclick="toggleImport()"><span>üìÇ Bulk Import (Excel / CSV)</span><span id="import-arrow">‚ñº</span></div>
                <div class="import-body" id="import-body">
                    <div class="import-help">Format: L1, L2, L3, L4, Value</div>
                    <textarea id="csvInput" placeholder="Region,Country,City,,100"></textarea>
                    <button class="btn-parse" onclick="parseCSV()">Parse & Overwrite Grid</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-json" class="tab-content"><textarea id="jsonInput"></textarea></div>

    <div id="tab-settings" class="tab-content">
        <div class="settings-card">
            <h3>Canvas Dimensions</h3>
            <div class="control-row"><label class="control-label">Chart Title</label><input type="text" id="chartTitle" placeholder="My Sunburst Chart" oninput="renderCurrent()"></div>
            <div class="control-grid">
                <div><label class="control-label">Width</label><input type="number" id="chartWidth" value="1000" onchange="renderCurrent()"></div>
                <div><label class="control-label">Height</label><input type="number" id="chartHeight" value="1000" onchange="renderCurrent()"></div>
            </div>
        </div>

        <div class="settings-card">
            <h3>Appearance</h3>
            <div class="control-row">
                <label class="control-label">Color Theme</label>
                <select id="colorTheme" onchange="applyThemeReset()">
                    <option value="vivid" selected>‚ú® Vivid</option>
                    <option value="ocean">Ocean</option>
                    <option value="sunset">Sunset</option>
                    <option value="forest">Forest</option>
                    <option value="corporate">Corporate</option>
                </select>
            </div>
            <div class="control-grid">
                <div><label class="control-label">Visual Style</label><select id="visualStyle" onchange="renderCurrent()"><option value="flat">Flat</option><option value="bevel">3D Bevel</option><option value="shadow">Shadow</option></select></div>
                <div><label class="control-label">Texture</label><select id="textureOverlay" onchange="renderCurrent()"><option value="none">None</option><option value="lines">Stripes</option><option value="dots">Dots</option></select></div>
            </div>
            <div class="sub-panel">
                <span class="sub-panel-title">Opacity</span>
                <div class="control-grid">
                    <div><label class="control-label">L1</label><input type="range" id="opL1" min="0.1" max="1" step="0.1" value="1" oninput="renderCurrent()"></div>
                    <div><label class="control-label">L2</label><input type="range" id="opL2" min="0.1" max="1" step="0.1" value="1" oninput="renderCurrent()"></div>
                    <div><label class="control-label">L3</label><input type="range" id="opL3" min="0.1" max="1" step="0.1" value="1" oninput="renderCurrent()"></div>
                    <div><label class="control-label">L4</label><input type="range" id="opL4" min="0.1" max="1" step="0.1" value="1" oninput="renderCurrent()"></div>
                </div>
            </div>
            <div class="control-row" style="margin-top: 15px;">
                <label class="control-label">Background</label>
                <div class="toggle-wrapper">
                    <input type="checkbox" id="bgTransparent" checked onchange="toggleBgColor()"> <span style="font-size:12px; flex:1;">Transparent</span>
                    <div class="color-btn"><input type="color" id="bgColor" value="#ffffff" disabled oninput="renderCurrent()"></div>
                </div>
            </div>
        </div>

        <div class="settings-card">
            <h3>Labels</h3>
            <div class="control-grid">
                <div><label class="control-label">Center Type</label><select id="centerContent" onchange="renderCurrent()"><option value="total">Total</option><option value="name">Root</option><option value="both">Both</option><option value="none">None</option></select></div>
                <div><label class="control-label">Custom Center</label><input type="text" id="customCenterText" placeholder="e.g. 2024" oninput="renderCurrent()"></div>
            </div>
            
            <div class="sub-panel" style="margin-top:15px;">
                <span class="sub-panel-title">Content per Level</span>
                <div class="control-row">
                    <label class="control-label">Level 1 (Inner)</label>
                    <select id="contentL1" onchange="renderCurrent()">
                        <option value="name" selected>Name</option><option value="value">Value</option><option value="percent">Percent</option><option value="name_colon_percent">Name: %</option><option value="all">All</option><option value="none">None</option>
                    </select>
                </div>
                <div class="control-row">
                    <label class="control-label">Level 2</label>
                    <select id="contentL2" onchange="renderCurrent()">
                        <option value="name" selected>Name</option><option value="value">Value</option><option value="percent">Percent</option><option value="name_colon_percent">Name: %</option><option value="all">All</option><option value="none">None</option>
                    </select>
                </div>
                <div class="control-row">
                    <label class="control-label">Level 3</label>
                    <select id="contentL3" onchange="renderCurrent()">
                        <option value="name" selected>Name</option><option value="value">Value</option><option value="percent">Percent</option><option value="name_colon_percent">Name: %</option><option value="all">All</option><option value="none">None</option>
                    </select>
                </div>
                <div class="control-row">
                    <label class="control-label">Level 4 (Outer)</label>
                    <select id="contentL4" onchange="renderCurrent()">
                        <option value="name" selected>Name</option><option value="value">Value</option><option value="percent">Percent</option><option value="name_colon_percent">Name: %</option><option value="all">All</option><option value="none">None</option>
                    </select>
                </div>
            </div>
            
            <div class="control-row" style="margin-top:10px;">
                <label class="control-label">Label Alignment</label>
                <select id="labelAttachment" onchange="renderCurrent()">
                    <option value="auto" selected>Auto (Side)</option>
                    <option value="middle">Center (Middle)</option>
                </select>
            </div>

            <div class="sub-panel">
                <span class="sub-panel-title">Positioning</span>
                <div class="control-row"><select id="labelPosition" onchange="toggleLabelControls(); renderCurrent()"><option value="inside">Inside</option><option value="outside">Outside (Pointers)</option></select></div>
                <div id="labelOffsetControl" style="margin-top:10px;">
                    <label class="control-label">Label Distance <span id="val-dist" class="range-val">25px</span></label>
                    <input type="range" id="labelDist" min="0" max="150" value="40" oninput="updateRangeLabel('dist', this.value, 'px'); renderCurrent()">
                    
                    <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label class="control-label">Nudge X</label><input type="range" id="textOffsetX" min="-50" max="50" value="0" oninput="renderCurrent()"></div>
                        <div><label class="control-label">Nudge Y</label><input type="range" id="textOffsetY" min="-50" max="50" value="0" oninput="renderCurrent()"></div>
                    </div>
                </div>
            </div>
            
             <div style="display:none;">
                <input id="strokeColor" value="#ffffff">
                <input id="strokeWidth" value="2">
                <input id="cornerRadius" value="4">
                <select id="fontFamily"><option value="Arial">Arial</option></select>
                <select id="fontWeight"><option value="bold">Bold</option></select>
                <select id="fontStyle"><option value="normal">Normal</option></select>
                <input id="fontSize" value="12">
                <input id="labelColor" value="#333333">
                <select id="labelOrientation"><option value="auto">Auto</option></select>
                <input id="labelRotation" value="0">
                <input id="pointerColor" value="#888888">
                <input id="pointerWidth" value="1">
                <select id="lineStyle"><option value="straight">Straight</option></select>
                <select id="showLabels"><option value="auto">Auto</option></select>
                <input id="chartPadding" value="50">
                <input id="sliceGap" value="0">
                <input id="ringGap" value="0">
                <select id="sortOrder"><option value="value">Value</option></select>
                <input id="valPrefix" value="">
                <input id="valSuffix" value="">
                <select id="showLegend"><option value="none">None</option></select>
                <input type="checkbox" id="showJsonTab">
             </div>
        </div>
    </div>

    <div id="sidebar-footer">
        <button class="update-btn-main" onclick="syncAndRender()">‚ü≥ Update Chart Preview</button>
    </div>
</div>

<div id="main">
    <div id="menu-container">
        <button id="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <div id="main-menu">
            <div class="menu-item" onclick="exportProject()">üíæ Save Project</div>
            <div class="menu-item" onclick="document.getElementById('importFile').click()">üìÇ Load Project</div>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importProject(this)">
            <div class="menu-separator"></div>
            <div class="menu-item" onclick="downloadImage('svg')">üì∑ Export SVG</div>
            <div class="menu-item" onclick="downloadImage('png')">üì∑ Export PNG</div>
            <div class="menu-item danger" onclick="clearStorage()">‚ö†Ô∏è Reset Data</div>
        </div>
    </div>
    <div id="chart"></div>
    <div id="tooltip" class="tooltip"></div>
</div>

<script>
    const STORAGE_KEY = 'sunburst_v7.1_robust';
    let activeTab = 'grid';
    let gridData = [
        { l1: "Marketing", l2: "Social", l3: "FB", l4: "", color: "#29aef6", val: 500 },
        { l1: "Marketing", l2: "Social", l3: "IG", l4: "", color: "#29aef6", val: 300 },
        { l1: "Sales", l2: "Direct", l3: "", l4: "", color: "#ff9800", val: 400 },
        { l1: "Sales", l2: "Channel", l3: "", l4: "", color: "#ff9800", val: 200 }
    ];

    // --- SAFETY HELPER: Prevents "Cannot read properties of null" ---
    function getVal(id, def) {
        const el = document.getElementById(id);
        return el ? (el.type === 'checkbox' ? el.checked : el.value) : def;
    }

    function getSettings() {
        return {
            chartWidth: getVal('chartWidth', 1000),
            chartHeight: getVal('chartHeight', 1000),
            chartTitle: getVal('chartTitle', ''),
            colorTheme: getVal('colorTheme', 'vivid'),
            visualStyle: getVal('visualStyle', 'flat'),
            textureOverlay: getVal('textureOverlay', 'none'),
            opL1: getVal('opL1', 1), opL2: getVal('opL2', 1),
            opL3: getVal('opL3', 1), opL4: getVal('opL4', 1),
            bgTransparent: getVal('bgTransparent', true),
            bgColor: getVal('bgColor', '#ffffff'),
            strokeColor: getVal('strokeColor', '#ffffff'),
            strokeWidth: getVal('strokeWidth', 2),
            cornerRadius: getVal('cornerRadius', 4),
            fontFamily: getVal('fontFamily', 'Arial'),
            fontWeight: getVal('fontWeight', 'bold'),
            fontStyle: getVal('fontStyle', 'normal'),
            fontSize: getVal('fontSize', 12),
            labelColor: getVal('labelColor', '#333333'),
            centerContent: getVal('centerContent', 'total'),
            customCenterText: getVal('customCenterText', ''),
            contentL1: getVal('contentL1', 'name'),
            contentL2: getVal('contentL2', 'name'),
            contentL3: getVal('contentL3', 'name'),
            contentL4: getVal('contentL4', 'name'),
            labelAttachment: getVal('labelAttachment', 'auto'),
            labelPosition: getVal('labelPosition', 'inside'),
            labelDist: getVal('labelDist', 20),
            textOffsetX: getVal('textOffsetX', 0),
            textOffsetY: getVal('textOffsetY', 0),
            labelOrientation: getVal('labelOrientation', 'auto'),
            labelRotation: getVal('labelRotation', 0),
            pointerColor: getVal('pointerColor', '#888888'),
            pointerWidth: getVal('pointerWidth', 1),
            showLabels: getVal('showLabels', 'auto'),
            chartPadding: getVal('chartPadding', 50),
            sliceGap: getVal('sliceGap', 0),
            ringGap: getVal('ringGap', 0),
            sortOrder: getVal('sortOrder', 'value'),
            valPrefix: getVal('valPrefix', ''),
            valSuffix: getVal('valSuffix', ''),
            showLegend: getVal('showLegend', 'none')
        };
    }

    function renderChart(data) {
        d3.select("#chart").html("");
        const s = getSettings();
        
        const width = parseInt(s.chartWidth);
        const height = parseInt(s.chartHeight);
        const svg = d3.select("#chart").append("svg")
            .attr("width", width).attr("height", height)
            .attr("viewBox", `0 0 ${width} ${height}`)
            .style("font-family", s.fontFamily);
            
        if(!s.bgTransparent) svg.style("background-color", s.bgColor);

        // -- CHART LOGIC --
        const hierarchy = d3.hierarchy(data).sum(d=>d.value);
        if(s.sortOrder === 'value') hierarchy.sort((a,b)=>b.value-a.value);
        
        // UNIQUE IDs
        hierarchy.descendants().forEach((d, i) => {
            let path = []; let curr = d;
            while(curr.parent) { path.unshift(curr.data.name); curr = curr.parent; }
            path.unshift(curr.data.name);
            d.uniqueId = path.join("-").replace(/[^a-zA-Z0-9]/g, '');
        });

        const radius = Math.min(width, height) / 2 - s.chartPadding;
        const root = d3.partition().size([2*Math.PI, radius])(hierarchy);
        
        const arc = d3.arc()
            .startAngle(d=>d.x0).endAngle(d=>d.x1)
            .padAngle(s.sliceGap * 0.005)
            .innerRadius(d=>d.y0).outerRadius(d => Math.max(d.y0, d.y1 - s.ringGap))
            .cornerRadius(s.cornerRadius);
            
        const g = svg.append("g").attr("transform", `translate(${width/2},${height/2})`);
        
        const colors = d3.scaleOrdinal(d3.schemeCategory10); // Simplified theme for stability

        // SLICES
        g.selectAll("path").data(root.descendants().filter(d=>d.depth)).join("path")
            .attr("d", arc)
            .attr("fill", d => d.data.color !== '#000000' ? d.data.color : colors(d.depth))
            .attr("stroke", s.strokeColor).attr("stroke-width", s.strokeWidth)
            .attr("opacity", d => s[`opL${d.depth}`] || 1);

        // LABELS
        if(s.showLabels !== 'none') {
            const labelNodes = root.descendants().filter(d => d.depth && (s.showLabels==='all' || (d.x1-d.x0) > 0.05));
            
            // POINTERS (Outside Only)
            if(s.labelPosition === 'outside') {
                const pointers = g.append("g");
                labelNodes.forEach(d => {
                    const angle = (d.x0 + d.x1)/2 - Math.PI/2;
                    const rInner = Math.max(d.y0, d.y1 - s.ringGap);
                    const rOuter = radius + parseInt(s.labelDist);
                    
                    // Simple line for robustness
                    const x1 = Math.cos(angle) * rInner;
                    const y1 = Math.sin(angle) * rInner;
                    const x2 = Math.cos(angle) * rOuter;
                    const y2 = Math.sin(angle) * rOuter;
                    
                    pointers.append("line").attr("x1",x1).attr("y1",y1).attr("x2",x2).attr("y2",y2)
                        .attr("stroke", s.pointerColor).attr("stroke-width", s.pointerWidth);
                        
                    d.labelX = x2; d.labelY = y2; // Save for text
                    d.angle = angle;
                });
            }
            
            // TEXT
            g.append("g").selectAll("text").data(labelNodes).join("text")
                .attr("transform", d => {
                    if(s.labelPosition === 'outside') {
                        // Apply Nudge
                        const finalX = d.labelX + parseInt(s.textOffsetX);
                        const finalY = d.labelY + parseInt(s.textOffsetY);
                        return `translate(${finalX}, ${finalY})`;
                    } else {
                        const angle = (d.x0 + d.x1)/2 * 180/Math.PI - 90;
                        const [x,y] = arc.centroid(d);
                        return `translate(${x},${y}) rotate(${angle < 180 ? angle : angle+180})`;
                    }
                })
                .attr("text-anchor", d => {
                     if(s.labelPosition === 'outside') {
                         if(s.labelAttachment === 'middle') return "middle";
                         return (d.angle > Math.PI/2 || d.angle < -Math.PI/2) ? "end" : "start";
                     }
                     return "middle";
                })
                .attr("dy", "0.35em")
                .style("font-size", s.fontSize + "px")
                .style("font-family", s.fontFamily)
                .style("fill", s.labelColor)
                .text(d => {
                    // Content Logic
                    let type = s[`contentL${d.depth}`];
                    if(type === 'none') return "";
                    let val = `${s.valPrefix}${d.value}${s.valSuffix}`;
                    let pct = ((d.value/root.value)*100).toFixed(1) + "%";
                    
                    if(type === 'percent') return pct;
                    if(type === 'value') return val;
                    if(type === 'name_colon_percent') return `${d.data.name}: ${pct}`;
                    return d.data.name; // Default
                });
        }
        
        // TITLE
        if(s.chartTitle) svg.append("text").attr("x", width/2).attr("y", 30).attr("text-anchor", "middle").style("font-size", "24px").text(s.chartTitle);
    }

    // --- REQUIRED FUNCTIONS FOR UI ---
    function switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        // Simple visual toggle for button, assumes button IDs match standard
    }
    
    function toggleImport() {
        const body = document.getElementById('import-body');
        body.classList.toggle('open');
    }
    
    function toggleLabelControls() {
        // Just for visual connection, logic handled in render
        const pos = document.getElementById('labelPosition').value;
        const div = document.getElementById('labelOffsetControl');
        if(div) div.style.display = pos === 'outside' ? 'block' : 'none';
    }
    
    function toggleBgColor() {
        document.getElementById('bgColor').disabled = document.getElementById('bgTransparent').checked;
        renderCurrent();
    }
    
    function updateRangeLabel(id, val, suffix) {
        const el = document.getElementById('val-'+id);
        if(el) el.innerText = val + suffix;
    }
    
    function addGridRow() {
        gridData.push({l1:"", l2:"", l3:"", l4:"", color:"#000000", val:0});
        renderGridRows();
        renderCurrent();
    }
    
    function renderGridRows() {
        const c = document.getElementById('rows-container');
        c.innerHTML = "";
        gridData.forEach((row, i) => {
            const div = document.createElement("div");
            div.className = "data-row";
            div.innerHTML = `
                <input type="text" class="lvl-input" value="${row.l1}" oninput="gridData[${i}].l1=this.value; renderCurrent()">
                <input type="text" class="lvl-input" value="${row.l2}" oninput="gridData[${i}].l2=this.value; renderCurrent()">
                <input type="text" class="lvl-input" value="${row.l3}" oninput="gridData[${i}].l3=this.value; renderCurrent()">
                <input type="text" class="lvl-input" value="${row.l4}" oninput="gridData[${i}].l4=this.value; renderCurrent()">
                <div class="color-wrapper"><input type="color" value="${row.color}" oninput="gridData[${i}].color=this.value; renderCurrent()"></div>
                <input type="number" class="val-input" value="${row.val}" oninput="gridData[${i}].val=Number(this.value); renderCurrent()">
                <div class="del-cell" onclick="gridData.splice(${i},1); renderGridRows(); renderCurrent()">√ó</div>
            `;
            c.appendChild(div);
        });
    }

    function syncAndRender() { renderCurrent(); }
    function renderCurrent() { saveState(); renderChart(getTreeData()); }
    function applyThemeReset() { renderCurrent(); }
    
    function getTreeData() {
        const root = { name: "Root", children: [] };
        gridData.forEach(r => {
            if(!r.l1) return;
            let n1 = root.children.find(c=>c.name===r.l1);
            if(!n1) { n1 = { name: r.l1, children: [], color: r.color }; root.children.push(n1); }
            if(!r.l2) { n1.value = (n1.value||0)+r.val; return; }
            
            let n2 = n1.children.find(c=>c.name===r.l2);
            if(!n2) { n2 = { name: r.l2, children: [], color: r.color }; n1.children.push(n2); }
            if(!r.l3) { n2.value = (n2.value||0)+r.val; return; }
            
            let n3 = n2.children.find(c=>c.name===r.l3);
            if(!n3) { n3 = { name: r.l3, children: [], color: r.color }; n2.children.push(n3); }
            if(!r.l4) { n3.value = (n3.value||0)+r.val; return; }
            
            n3.children.push({ name: r.l4, value: r.val, color: r.color });
        });
        return root;
    }
    
    // -- INIT --
    function init() {
        renderGridRows();
        renderCurrent();
    }
    
    init(); // Boot
</script>
</body>
</html>
